# 100%ä»£ç è¦†ç›–ç‡çš„ç¥è¯

> åŸæ–‡ï¼š<https://medium.com/hackernoon/the-100-code-coverage-myth-900b83d20d3d>

![](img/09318ad51d1ca59d5c500744e2b0b492.png)

Licensed from Adobe Stock Photo

ç°åœ¨äº’è”ç½‘ä¸Šæœ‰å¾ˆå¤šå»ºè®®è¯´ 100%çš„è¦†ç›–ç‡ä¸æ˜¯ä¸€ä¸ªå€¼å¾—è¿½æ±‚çš„ç›®æ ‡ã€‚

æˆ‘å¼ºçƒˆåå¯¹ã€‚

é€šå¸¸ï¼Œä»£ç éš¾ä»¥æµ‹è¯•æ˜¯éœ€è¦é‡æ„çš„æ ‡å¿—ã€‚

æˆ‘æ˜ç™½äº†ã€‚å‡ å¹´å‰ï¼Œæˆ‘çš„æµ‹è¯•å¾ˆç³Ÿç³•ã€‚æˆ‘ä»¥ä¸ºè¿™åªæ˜¯ä¼šè®©æˆ‘èµ°å¾—æ›´æ…¢çš„ä¸œè¥¿ã€‚

å½“æˆ‘å¼€å§‹ç¼–ç çš„æ—¶å€™ï¼Œäººä»¬å¾ˆå°‘è¿™ä¹ˆåšã€‚å¦‚æœæ˜¯çš„è¯ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ QA å›¢é˜Ÿè´Ÿè´£ã€‚å‡ å¹´å‰ï¼Œè™½ç„¶å®ƒæˆä¸ºä¸€ä¸ªçœŸæ­£çš„çƒ­é—¨è¯é¢˜ã€‚é¢è¯•å¼€å§‹æœŸæœ›å€™é€‰äººçŸ¥é“å¦‚ä½•å†™æµ‹è¯•ï¼Œè¶Šæ¥è¶Šå¤šçš„ç»„ç»‡è‡ªä¸Šè€Œä¸‹åœ°æ¨åŠ¨å®ƒä½œä¸ºä¸€ä¸ªè´¨é‡å€¡è®®ã€‚

æˆ‘æ€»æ˜¯åŠªåŠ›åšåˆ°æœ€å¥½ï¼Œæˆ‘å†³å®šèµ°è¿›é¢è¯•æ—¶è¯´â€œæµ‹è¯•ä¸æ˜¯æˆ‘çš„å¼ºé¡¹â€ä¸å†æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œæ‰€ä»¥æˆ‘å†³å®šä»é‚£æ—¶èµ·æˆ‘è¦å¯¹æˆ‘çš„æ‰€æœ‰æµ‹è¯•è¿›è¡Œ 100%çš„è¦†ç›–ã€‚

å½“æ—¶ï¼Œæˆ‘çœŸçš„ä¸ç¡®å®šæˆ‘èƒ½ä»ä¸­å¾—åˆ°ä»€ä¹ˆå¥½å¤„ï¼Œæˆ–è€…çœŸçš„æœ‰ä»€ä¹ˆå¥½å¤„ã€‚

ç°åœ¨ï¼Œæˆ‘*è€è€å®å®*ä¸å›å»äº†ã€‚å½“ 100%è¦†ç›–ç‡çš„ä»£ç åº“å‡ºç°é—®é¢˜æ—¶ï¼Œæ‚¨çš„æµ‹è¯•å¾ˆå¯èƒ½ä¼šå‘Šè¯‰æ‚¨å…·ä½“çš„ä½ç½®å’Œæ–¹å¼ã€‚

è¿™å¹¶ä¸æ˜¯è¯´å•å…ƒæµ‹è¯•å°±æ˜¯ä½ æ‰€éœ€è¦çš„ã€‚å®ƒä¸æ˜¯ã€‚ä½†æ˜¯åœ¨æˆ‘çœ‹æ¥ï¼Œè®©ä»£ç æœªç»æµ‹è¯•ä¹Ÿä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚

è·Ÿæˆ‘å›å»å§ï¼Œå›åˆ°æˆ‘ä¹Ÿä¸ç›¸ä¿¡æµ‹è¯•è¦†ç›–çš„å¥½å¤„çš„æ—¶å€™ã€‚

# **ç¬¬ä¸€éƒ¨åˆ†:å­¦ä¹ è¡Œè¯**

å½“æ—¶äº¤æ˜“çš„å·¥å…·æ˜¯[æ‘©å¡](https://mochajs.org/)ã€[è¥¿å†œ](https://sinonjs.org/)å’Œ[æŸ´](https://www.chaijs.com/)çš„ç»„åˆã€‚Mocha æ˜¯æµ‹è¯•è€…ï¼Œsinon æä¾›äº†åˆ›å»ºâ€œæ¨¡æ‹Ÿâ€å’Œâ€œé—´è°â€çš„èƒ½åŠ›ï¼Œè€Œ chai æ˜¯ä¸€ä¸ªæ–­è¨€åº“ï¼Œå› æ­¤æ‚¨å¯ä»¥ä»¥äººç±»è¯­è¨€å‹å¥½çš„æ–¹å¼é”®å…¥æ–­è¨€ã€‚

![](img/5842b1e36ea3d750cb72c07bdd4c7777.png)

Is this a spy?

æˆ‘æ ¹æœ¬ä¸çŸ¥é“è¿™æ„å‘³ç€ä»€ä¹ˆã€‚åœ¨æˆ‘å˜å¾—æœ‰æ•ˆç‡ä¹‹å‰ï¼Œé¦–å…ˆè¦åšçš„æ˜¯å­¦ä¹ è¯­è¨€ã€‚

æ‰€ä»¥ï¼Œé¦–å…ˆï¼Œåˆ°åº•æ˜¯é—´è°è¿˜æ˜¯éª—å­ï¼Ÿ

è™½ç„¶æˆ‘é¦–å…ˆæƒ³åˆ°çš„æ˜¯è©¹å§†æ–¯Â·é‚¦å¾·æˆ–è€…ä¼Šæ£®Â·äº¨ç‰¹ã€‚è¿™ç»å¯¹ä¸æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œè°ˆè®ºçš„ï¼Œå°½ç®¡è¿™ä¸æ˜¯ä¸€ä¸ªå¯æ€•çš„æ¯”å–»ã€‚

åœ¨é˜…è¯»äº†ä¸€äº›æ–‡æ¡£åï¼Œæˆ‘æœ€ç»ˆäº†è§£åˆ° spy æ˜¯ä¸€ä¸ªè¢«æµ‹è¯•æ¡†æ¶ä¿®æ”¹è¿‡çš„å‡½æ•°ï¼Œå®ƒæä¾›äº†å…³äºå®ƒå¦‚ä½•è¢«ä½¿ç”¨çš„å…ƒä¿¡æ¯ã€‚å®ƒæš—ä¸­ç›‘è§†å®ƒã€‚æœ‰ç‚¹åƒäººä»¬å¦‚ä½•é€šè¿‡è‹¹æœæœ€è¿‘çš„ FaceTime Bug æ¥ç›‘è§†ä½ ã€‚æœ‰ç‚¹åƒè©¹å§†æ–¯Â·é‚¦å¾·ã€‚

æ¨¡ä»¿å’Œé—´è°å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒè¢«ä¿®æ”¹å¾—æ›´å¤šã€‚é™¤äº†æä¾›å’Œè·Ÿè¸ªç‰¹å®šå‡½æ•°çš„ä½¿ç”¨æƒ…å†µï¼Œå®ƒè¿˜æ”¹å˜äº†å…¶è¡Œä¸ºï¼Œä½¿å…¶å˜å¾—å¯é¢„æµ‹ã€‚

æˆ‘è¿˜äº†è§£åˆ°æœ‰å‡ ç§æµ‹è¯•ã€‚ä¸é™äºæœ€å¸¸è§çš„ä¸‰ç§:å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œ E2E æµ‹è¯•ã€‚

å½“æˆ‘ä»¬è¿›è¡Œâ€œå•å…ƒæµ‹è¯•â€æ—¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿå°†ä»£ç åˆ†è§£æˆå•ç‹¬çš„å•å…ƒã€‚è¯¥ç‰¹å®šå•å…ƒä¹‹å¤–çš„ä»»ä½•ä¸œè¥¿éƒ½æ˜¯è¢«å˜²ç¬‘çš„å¯¹è±¡ï¼Œæ¯”å¦‚å…¶ä»–å‡½æ•°æˆ–æ•´ä¸ªæ¨¡å—ã€‚Jest æ˜¯æˆ‘é€‰æ‹©çš„å•å…ƒæµ‹è¯•å·¥å…·ã€‚å•å…ƒæµ‹è¯•æ˜¯å”¯ä¸€æµ‹é‡è¦†ç›–ç‡çš„æµ‹è¯•ç±»å‹ã€‚

å½“æˆ‘ä»¬è¿›è¡Œé›†æˆæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬æ˜¯åœ¨æµ‹è¯•æˆ‘ä»¬çš„è½¯ä»¶ä¸å…¶ä»–è½¯ä»¶çš„é›†æˆï¼Œä¾‹å¦‚é€šè¿‡ Kafka ä¼ é€’æˆ‘ä»¬çš„æœåŠ¡åº”è¯¥æ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„æµ‹è¯•ï¼Œå¹¶ä¸”ä¹‹åå¯ä»¥åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°å…¶ç»“æœã€‚åœ¨åˆ›å»ºé›†æˆæµ‹è¯•æ—¶ï¼Œæˆ‘ä¹Ÿç»å¸¸å¼€ç©ç¬‘ã€‚

E2E æµ‹è¯•æœ‰ç‚¹åƒä½¿ç”¨ä½ çš„åº”ç”¨ç¨‹åºçš„æœºå™¨äººã€‚ä½ æŠŠå®ƒç¼–ç¨‹ä¸ºåœ¨æµè§ˆå™¨ä¸­åŠ è½½ç«™ç‚¹ï¼Œç‚¹å‡»ä¸œè¥¿ï¼Œå¹¶ç¡®ä¿ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ä¸€åˆ‡éƒ½æŒ‰é¢„æœŸå·¥ä½œã€‚åœ¨è¿™æ–¹é¢ï¼ŒCypress æ˜¯æˆ‘æœ€å–œæ¬¢çš„å·¥å…·ï¼Œä½†æ˜¯åœ¨æˆ‘å­¦ä¹ çš„æ—¶å€™å®ƒè¿˜ä¸å­˜åœ¨ã€‚Selenium æ˜¯å½“æ—¶çš„å¤§ç©å®¶ï¼Œè€å®è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤§çš„é¢†åŸŸï¼Œæˆ‘å¾ˆä¹æ„è®© QA è‡ªåŠ¨åŒ–å·¥ç¨‹å¸ˆæ¥å¤„ç†è¿™ä¸€éƒ¨åˆ†ã€‚

æœ‰äº†æ–°çŸ¥è¯†ï¼Œç°åœ¨æ˜¯å›°éš¾çš„éƒ¨åˆ†:æŠŠå®ƒä»˜è¯¸å®è·µã€‚

æˆ‘èŠ±äº†å‡ ä¸ªæœˆçš„æ—¶é—´æ¥ç¡®ä¿æˆ‘å†™çš„æ¯ä¸€æ®µä»£ç éƒ½æœ‰æµ‹è¯•è¦†ç›–ç‡ã€‚èµ·åˆï¼Œæˆ‘æ‰¿è®¤ï¼Œè¿™å¾ˆå›°éš¾ã€‚æˆ‘èŠ±äº†å¾ˆå¤šæ—¶é—´åœ¨ StackOverflow ä¸ŠæŸ¥æ‰¾å˜²è®½å’Œåˆºæ¢çš„ä¾‹å­ã€‚åˆ°æœ€åï¼Œæˆ‘å‘ç°æˆ‘å¯¹æˆ‘çš„ä»£ç çš„ä¿¡å¿ƒå¤§å¤§æé«˜äº†ã€‚

å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå½“æˆ‘çš„æµ‹è¯•å‡ºç°é—®é¢˜æ—¶ï¼Œé€šå¸¸ä¼šå‘Šè¯‰æˆ‘ç¡®åˆ‡çš„ä½ç½®ã€‚å½“å…¶ä»–å·¥ç¨‹å¸ˆå¯¹æˆ‘çš„ä»£ç è¿›è¡Œä¿®æ”¹æ—¶ï¼Œæˆ‘å¯ä»¥æ›´å¿«åœ°æ£€æŸ¥å®ƒã€‚å½“é‡è¦çš„ API æ”¹å˜æ—¶ï¼Œäººä»¬é€šè¿‡å¤±è´¥çš„æµ‹è¯•å¾—åˆ°è­¦å‘Šï¼Œè¦ä¹ˆå¿«é€Ÿæ›´æ–°å®ƒï¼Œè¦ä¹ˆé‡æ–°è€ƒè™‘ä»–ä»¬çš„æ”¹å˜ã€‚

ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘å¼€å§‹ç¼–å†™æ›´å¥½çš„ä»£ç ã€‚æˆ‘äº†è§£åˆ°ï¼Œé€šå¸¸å¦‚æœæœ‰äº›ä¸œè¥¿å¾ˆéš¾æµ‹è¯•ï¼Œæˆ–è€…å¾ˆéš¾å®Œå…¨è¦†ç›–ï¼Œè¿™é€šå¸¸æ„å‘³ç€æˆ‘æ²¡æœ‰å†™å¥½ä»£ç ï¼Œå®ƒå¯ä»¥è¢«é‡æ„ï¼Œä»è€Œäº§ç”Ÿæ›´æ˜“ç»´æŠ¤å’Œæ›´çµæ´»çš„ APIã€‚ä¸ºæ­¤ï¼Œè¯•å›¾è¾¾åˆ° 100%çš„è¦†ç›–ç‡é¼“åŠ±æˆ‘å°†åŒ¿åå‡½æ•°æå–åˆ°å‘½åå‡½æ•°ä¸­ï¼Œå¹¶ç†è§£è®¸å¤šé‡æ„ä¸­çš„éƒ¨åˆ†åº”ç”¨ç¨‹åºå’Œä¾èµ–æ³¨å…¥ã€‚

åœ¨å®Œæˆé›†æˆæµ‹è¯•ä¹‹åï¼Œæˆ‘ç”šè‡³æ”¾å¼ƒäº† GitFlowï¼Œè½¬è€Œè¿›è¡ŒåŸºäºä¸»å¹²çš„å¼€å‘ã€‚å‡ å¹´å‰ï¼Œæˆ‘è®¤ä¸ºè‡´åŠ›äº master æ˜¯ä¸€ä»¶ç–¯ç‹‚çš„äº‹æƒ…ï¼Œç°åœ¨ï¼Œæˆ‘æ¯å¤©éƒ½åœ¨ä¸€ä¸ªç”±è¿‘ 15 åå·¥ç¨‹å¸ˆç»„æˆçš„å›¢é˜Ÿä¸­è¿™æ ·åšã€‚

[](https://hackernoon.com/i-have-a-confession-to-make-i-commit-to-master-6a804f334beb) [## æˆ‘è¦å‘ä½ å¦ç™½â€¦æˆ‘å‘å¸ˆçˆ¶æ‰¿è¯ºã€‚

### æˆ‘æ›¾ç»é¼“å¹ Git Flow æ¥ä¿æŒæˆ‘çš„ä»£ç å¯å‘å¸ƒã€å¯å›æ»šï¼Œå¹¶ä¿æŒä¸€ä¸ªå¹²å‡€çš„å†å²ã€‚ä½†ç°åœ¨ä¸æ˜¯äº†â€”â€”

hackernoon.com](https://hackernoon.com/i-have-a-confession-to-make-i-commit-to-master-6a804f334beb) 

# ç¬¬ 2 éƒ¨åˆ†:ä»¥èº«ä½œåˆ™

åœ¨æˆ‘å¯¹æˆ‘çš„æ–°æµ‹è¯•æ ˆè¶Šæ¥è¶Šæœ‰ä¿¡å¿ƒçš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªå·¥å…·è¢«å¼•å…¥å¸‚åœºï¼Œè®¸å¤šäººå£°ç§°å®ƒä½¿å•å…ƒæµ‹è¯•æ›´åŠ ç®€å•:Jestã€‚

Jest æ˜¯ç”±è„¸ä¹¦é¦–åˆ›çš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ã€‚

Jest åšäº†ä¸€ä»¶éå¸¸æ£’çš„å·¥ä½œï¼Œå°†æˆ‘ä»¥å‰ä½¿ç”¨çš„åº“æµ“ç¼©åˆ°ä¸€ä¸ªè¿è´¯çš„æ¡†æ¶ä¸­ï¼Œè¿™ä¸ªæ¡†æ¶æ˜¯ä¸€ä¸ªæµ‹è¯•è¿è¡Œå™¨ï¼Œä»¥åŠä¸€ç»„ç”¨äºæ¨¡ä»¿ã€ç›‘è§†å’Œæ–­è¨€çš„ APIã€‚é™¤äº†æä¾›æ»¡è¶³æ‰€æœ‰å•å…ƒæµ‹è¯•éœ€æ±‚çš„å•ä¸€åº“ä¹‹å¤–ï¼ŒJest åœ¨ç®€åŒ–ä¸€äº›æ¦‚å¿µå’Œæ¨¡å¼ä»¥åŠå¼ºå¤§è€Œç®€å•çš„æ¨¡æ‹Ÿæ–¹é¢åšå¾—å¾ˆå¥½ã€‚

å› ä¸ºæˆ‘è®¤ä¸º Jest æ›´å®¹æ˜“ä½¿ç”¨å’Œç†è§£ï¼Œæ‰€ä»¥æˆ‘å°†ç»§ç»­ä½¿ç”¨ Jest ä½œä¸ºä¾‹å­ã€‚

å¦‚æœä½ åªæ˜¯å’Œæˆ‘ä¸€èµ·å†™è¿™ç¯‡æ–‡ç« ï¼Œé‚£å¾ˆå¥½â€”â€”åˆ°ç›®å‰ä¸ºæ­¢ä½ æ‰€è¯»åˆ°çš„å†…å®¹æ˜¯ç‹¬ç«‹çš„ã€‚ç„¶è€Œï¼Œæˆ‘ä¸€ç›´åœ¨è®°å½•ä½¿ç”¨ Parcel with Streaming SSR æ„å»º React åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ï¼Œæœ¬æ–‡å°†ä»ä¸Šä¸€éƒ¨åˆ†åœæ­¢çš„åœ°æ–¹ç»§ç»­ã€‚

åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« (é“¾æ¥å¦‚ä¸‹)ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•ç”¨ä»£ç è¦†ç›–ç‡è®¾ç½® Jestï¼Œå¹¶è¯´åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘å°†å±•ç¤ºå¦‚ä½•è·å¾—é«˜è¾¾ 100%çš„è¦†ç›–ç‡ã€‚

[](https://hackernoon.com/enforcing-code-quality-for-node-js-c3b837d7ae17) [## å¼ºåˆ¶ Node.js çš„ä»£ç è´¨é‡

### ä½¿ç”¨æ—æŒºã€æ ¼å¼åŒ–å’Œå¸¦æœ‰ä»£ç è¦†ç›–çš„å•å…ƒæµ‹è¯•æ¥å®æ–½è´¨é‡æ ‡å‡†

hackernoon.com](https://hackernoon.com/enforcing-code-quality-for-node-js-c3b837d7ae17) 

æˆ‘è®¤ä¸ºå±•ç¤º 100%è¦†ç›–ç‡çš„æœ€å¥½æ–¹å¼æ˜¯å±•ç¤ºå¦‚ä½•åˆ°è¾¾é‚£é‡Œã€‚åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå‘ç°å‡ ä¸ªåœ°æ–¹çš„ä»£ç å¯ä»¥é‡æ„ï¼Œä»¥æé«˜å¯æµ‹è¯•æ€§ã€‚å› æ­¤ï¼Œæˆ‘å°†ä»æˆ‘åœæ­¢çš„åœ°æ–¹ç»§ç»­ï¼Œå¹¶ä½¿è¿™ä¸ªé¡¹ç›®çš„è¦†ç›–ç‡è¾¾åˆ° 100%ï¼Œå¹¶å±•ç¤ºè¦åšä»€ä¹ˆæ ·çš„é‡æ„ï¼Œåœ¨å“ªé‡Œä½¿ç”¨éƒ¨åˆ†åº”ç”¨ç¨‹åºå’Œä¾èµ–æ³¨å…¥ï¼Œä»¥åŠå½“è¦†ç›–ç‡éš¾ä»¥è¾¾åˆ°æ—¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¦æ¨¡ä»¿ä»€ä¹ˆã€‚

é‚£ä¹ˆâ€¦è®©æˆ‘ä»¬å¼€å§‹å§ã€‚è¿™æ˜¯æˆ‘å°†è¦åšçš„é¡¹ç›®:

[](https://github.com/patrickleet/streaming-ssr-react-styled-components) [## Patrick let/streaming-SSR-react-styled-ç»„ä»¶

### æµå¼ ssr ååº”é£æ ¼ç»„ä»¶ä¸åŒ…è£¹ã€‚è´¡çŒ®ç»™ Patrick let/streaming-SSR-react-styled-componentsâ€¦

github.com](https://github.com/patrickleet/streaming-ssr-react-styled-components) 

è¯¥é¡¹ç›®åœ¨`app`æ–‡ä»¶å¤¹ä¸­æœ‰ä¸€ä¸ª react åº”ç”¨ç¨‹åºï¼Œä»¥åŠä¸€ä¸ªåŒ…å« SSR é€»è¾‘çš„`server`æ–‡ä»¶å¤¹ã€‚è®©æˆ‘ä»¬ä»åº”ç”¨ç¨‹åºæµ‹è¯•å¼€å§‹ã€‚

## åº”ç”¨æµ‹è¯•

åœ¨[çš„ä¸Šä¸€ç¯‡æ–‡ç« ](https://hackernoon.com/enforcing-code-quality-for-node-js-c3b837d7ae17)ä¸­ï¼Œåœ¨é…ç½® Jest ä¹‹åï¼Œæˆ‘å¼€å§‹å¯¹ä¸€ä¸ªç®€å•çš„ç»„ä»¶è¿›è¡Œç®€å•çš„æµ‹è¯•ã€‚æˆ‘æœ‰å‡ ä¸ªåŒæ ·ç®€å•çš„ React ç»„ä»¶ã€‚

è¿™ä¹Ÿæ˜¯åŠŸèƒ½ç»„ä»¶çœŸæ­£å¼ºå¤§çš„åŸå› ä¹‹ä¸€ã€‚å‡½æ•°æ¯”ç±»æ›´å®¹æ˜“æµ‹è¯•ã€‚å®ƒä»¬æ²¡æœ‰çŠ¶æ€ï¼Œè€Œæ˜¯æœ‰è¾“å…¥å’Œè¾“å‡ºã€‚ç»™å®šè¾“å…¥ Xï¼Œå®ƒä»¬æœ‰è¾“å‡º yã€‚å½“æœ‰çŠ¶æ€æ—¶ï¼Œå®ƒå¯ä»¥å­˜å‚¨åœ¨ç»„ä»¶çš„å¤–éƒ¨ã€‚

æ–°çš„ React Hooks API åœ¨è¿™æ–¹é¢å¾ˆå¥½ï¼Œå› ä¸ºå®ƒé¼“åŠ±åˆ›å»ºåŠŸèƒ½ç»„ä»¶ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå®¹æ˜“æ¨¡ä»¿çš„æœºåˆ¶æ¥ä¸ºç»„ä»¶æä¾›çŠ¶æ€ã€‚Redux åœ¨æµ‹è¯•æ–¹é¢æä¾›äº†åŒæ ·çš„å¥½å¤„ã€‚

è®©æˆ‘ä»¬ä»æ•²å‡ºå…¶ä½™çš„ç®€å•ç»„ä»¶å¼€å§‹ã€‚æˆ‘ä»¬åŸºæœ¬ä¸Šåªéœ€è¦æ¸²æŸ“å®ƒä»¬ï¼Œå¹¶æ£€æŸ¥ä¸€äº›é‡è¦çš„ä¿¡æ¯æ˜¯å¦è¢«æ¸²æŸ“ã€‚

æˆ‘é€šå¸¸å°†ä»£ç å†…åµŒåœ¨æ–‡ç« ä¸­ï¼Œä½†æ˜¯è¿™äº›æµ‹è¯•ä¸­å¹¶æ²¡æœ‰ä»€ä¹ˆæ–°çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘å†³å®šé“¾æ¥åˆ°å®é™…çš„æäº¤ï¼Œå¹¶ä¸”åªå±•ç¤ºä¸€ä¸ªå®Œæ•´çš„ä¾‹å­:

è®©æˆ‘ä»¬çœ‹çœ‹â€œå…³äºâ€é¡µé¢:

```
import React from 'react'
import Helmet from 'react-helmet-async'
import Page from '../components/Page'const About = () => (
  <Page>
    <Helmet>
      <title>About Page</title>
    </Helmet> <div>This is the about page</div>
  </Page>
)export default About
```

è¿™æ˜¯æµ‹è¯•:

```
import React from 'react'
import { shallow } from 'enzyme'
import About from 'app/pages/About.jsx'describe('app/pages/About.jsx', () => {
  it('renders About page', () => {
    expect(About).toBeDefined()
    const tree = shallow(<About />)
    expect(tree.find('Page')).toBeDefined()
    expect(
      tree
        .find('Helmet')
        .find('title')
        .text()
    ).toEqual('About Page')
    expect(tree.find('div').text()).toEqual('This is the about page')
  })
})
```

ä»¥ä¸‹æäº¤ä¸­çš„æ‰€æœ‰æµ‹è¯•éƒ½éå¸¸ç›¸ä¼¼:

*   [ä¿®å¤:é¡µé¢æµ‹è¯•](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/3a81d9e2cdad6d025527f27e7d73e6ce9a670a8c)
*   [ä¿®å¤:ç»„ä»¶æµ‹è¯•](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/49ff4a2a4fedecb03be9292c32a36ca7258188a5)
*   [æµ‹è¯•:æ ·å¼ç»„ä»¶æ¸²æŸ“æµ‹è¯•](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/5a05a969f35bd8d2f7c68dacb8b8a03f9618819d)

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä»…ä»…ç¡®ä¿æˆ‘ä»¬çš„ç»„ä»¶æ¸²æŸ“å°±è¶³ä»¥è®©è¿™äº›ç»„ä»¶è·å¾— 100%çš„è¦†ç›–ç‡ã€‚æ›´è¯¦ç»†çš„äº¤äº’æœ€å¥½ç•™ç»™ E2E æµ‹è¯•ï¼Œè¿™è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚

ä¸‹ä¸€ä¸ªç»„ä»¶`app/App.jsx`ç¨å¾®å¤æ‚ä¸€äº›ã€‚åœ¨ç¼–å†™äº†ä¸€ä¸ªæ¸²æŸ“æµ‹è¯•ä¹‹åï¼Œæ‚¨ä¼šæ³¨æ„åˆ°è·¯ç”±å™¨ä¸­ä»ç„¶æœ‰ä¸€ä¸ªä¸å¯åˆ°è¾¾çš„åŒ¿åå‡½æ•°ç”¨äºæ¸²æŸ“ About é¡µé¢ã€‚

ä¸ºäº†è®¿é—®å’Œæµ‹è¯•å®ƒï¼Œæˆ‘ä»¬æƒ³åšä¸€ä¸ªå°çš„é‡æ„ï¼Œå°†å‡½æ•°æå–åˆ°ä¸€ä¸ªå‘½åå‡½æ•°ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¼å‡ºå®ƒå¹¶è¿›è¡Œæµ‹è¯•ã€‚

![](img/6d5575cad760d7fe1d438000d37e98cb.png)

ç°åœ¨å¾ˆå®¹æ˜“æµ‹è¯•:

![](img/eeacddf55347e1516649a76b4ad2c75d.png)

å› ä¸ºæˆ‘ä»¬å¯¹ä¸Šé¢çš„ About é¡µé¢æœ‰å¦ä¸€ç»„æµ‹è¯•ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒçš„æ›´å…·ä½“çš„æµ‹è¯•ç•™åœ¨é‚£é‡Œï¼Œåªéœ€è¦æ£€æŸ¥å®ƒåœ¨è¿™é‡Œçš„å‘ˆç°ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å‰©ä¸‹çš„å”¯ä¸€è¦æµ‹è¯•çš„æ–‡ä»¶æ˜¯`app/client.js`ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ç»§ç»­å®ŒæˆæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç :

```
import React from 'react'
import ReactDOM from 'react-dom'
import { HelmetProvider } from 'react-helmet-async'
import { BrowserRouter } from 'react-router-dom'
import { rehydrateMarks } from 'react-imported-component'
import importedComponents from './imported' // eslint-disable-line
import App from './App'const element = document.getElementById('app')
const app = (
  <HelmetProvider>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </HelmetProvider>
)// In production, we want to hydrate instead of render
// because of the server-rendering
if (process.env.NODE_ENV === 'production') {
  // rehydrate the bundle marks
  rehydrateMarks().then(() => {
    ReactDOM.hydrate(app, element)
  })
} else {
  ReactDOM.render(app, element)
}// Enable Hot Module Reloading
if (module.hot) {
  module.hot.accept()
}
```

æˆ‘æ³¨æ„åˆ°çš„ç¬¬ä¸€ä»¶äº‹æ˜¯å¯¹å…¨å±€å˜é‡çš„ä¾èµ–â€”â€”`document`ã€`process`å’Œ`module`ã€‚ç¬¬äºŒä»¶äº‹æ˜¯æ²¡æœ‰å¯¼å‡ºä»»ä½•ä¸œè¥¿ï¼Œæ‰€ä»¥å¯èƒ½å¾ˆéš¾ç”¨ä¸åŒçš„è¾“å…¥è¿è¡Œå¤šæ¬¡ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›é‡æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜:

1.  å°†æ‰€æœ‰çš„é€»è¾‘æ‰“åŒ…æˆä¸€ä¸ªå¯ä»¥å¯¼å‡ºçš„å‡½æ•°ã€‚è¯¥å‡½æ•°å°†æ¥å—ä¸€ä¸ªé€‰é¡¹å¯¹è±¡åŠå…¶æ‰€æœ‰ä¾èµ–é¡¹ã€‚è¿™è¢«ç§°ä¸º**ä¾èµ–æ³¨å…¥**ã€‚å¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬è½»æ¾åœ°ä¼ é€’ä¸€å †äº‹ç‰©çš„æ¨¡æ‹Ÿç‰ˆæœ¬ã€‚
2.  æˆ‘ä»¬æœ‰ä¸€ä¸ªåœ¨ç”Ÿäº§æ¨¡å¼ä¸­çš„åŒ¿åå‡½æ•°ï¼Œå®ƒåº”è¯¥è¢«æå–ä¸ºä¸€ä¸ªå‘½åå‡½æ•°ã€‚

æˆ‘ä»¬è¿˜æƒ³æ¨¡ä»¿ä¸€äº›å¤–éƒ¨æ¨¡å—:`react-dom`ã€`react-imported-component`å’Œ`app/imported.js`ã€‚æ¨¡å—æœ¬èº«å°±æ˜¯ä¾èµ–æ³¨å…¥çš„ä¸€ç§å½¢å¼ã€‚

é¦–å…ˆï¼Œè¿™é‡Œæ˜¯æ–°é‡æ„çš„æ–‡ä»¶ï¼Œæ›´æ”¹ä»¥ç²—ä½“æ˜¾ç¤º:

```
import React from 'react'
import ReactDOM from 'react-dom'
import { HelmetProvider } from 'react-helmet-async'
import { BrowserRouter } from 'react-router-dom'
import { rehydrateMarks } from 'react-imported-component'
import importedComponents from './imported' // eslint-disable-line
import App from './App'// use "partial application" to make this easy to test **export const hydrate = (app, element) => () => {
  ReactDOM.hydrate(app, element)
}****export const start = ({ 
  isProduction,
  document,
  module,
  hydrate
 }) => {**
  const element = document.getElementById('app')
  const app = (
    <HelmetProvider>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </HelmetProvider>
  ) // In production, we want to hydrate instead of render
  // because of the server-rendering
  if (**isProduction**) {
    // rehydrate the bundle marks from imported-components, 
    // then rehydrate the react app
    rehydrateMarks().then(**hydrate(app, element)**)
  } else {
    ReactDOM.render(app, element)
  } // Enable Hot Module Reloading
  if (module.hot) {
    module.hot.accept()
  }
}**const options = {
  isProduction: process.env.NODE_ENV === 'production',
  document: document,
  module: module,
  hydrate
}****start(options)**
```

ç°åœ¨ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥ä½¿ç”¨å„ç§é€‰é¡¹è®¿é—®å’Œæµ‹è¯• startï¼Œå¹¶ç‹¬ç«‹äºå¯åŠ¨é€»è¾‘æµ‹è¯•æ°´åˆç‰©ã€‚

æµ‹è¯•æœ‰ç‚¹é•¿ï¼Œæ‰€ä»¥æˆ‘åœ¨é‡Œé¢æ”¾äº†æ³¨é‡Šæ¥è§£é‡Šå‘ç”Ÿäº†ä»€ä¹ˆã€‚ä»¥ä¸‹æ˜¯å¯¹è¯¥æ–‡ä»¶çš„æµ‹è¯•:

```
import React from 'react'
import fs from 'fs'
import path from 'path'
import { start, hydrate } from 'app/client'
import { JSDOM } from "jsdom"jest.mock('react-dom')
jest.mock('react-imported-component')
jest.mock('app/imported.js')// mock DOM with actual index.html contents
const pathToIndex = path.join(process.cwd(), 'app', 'index.html')
const indexHTML = fs.readFileSync(pathToIndex).toString()
const DOM = new JSDOM(indexHTML)
const document = DOM.window.document// this doesn't contribute to coverage, but we
// should know if it changes as it would
// cause our app to break
describe('app/index.html', () => {
  it('has element with id "app"', () => {
    const element = document.getElementById('app')
    expect(element.id).toBe('app')
  })
})describe('app/client.js', () => { // Reset counts of mock calls after each test
  afterEach(() => {
    jest.clearAllMocks()
  }) describe('#start', () => {
    it('renders when in development and accepts hot module reloads', () => {
      // this is mocked above, so require gets the mock version
      // so we can see if its functions are called
      const ReactDOM = require('react-dom')

      // mock module.hot
      const module = {
        hot: {
          accept: jest.fn()
        }
      } // mock options
      const options = {
        isProduction: false,
        module,
        document
      } start(options)
      expect(ReactDOM.render).toBeCalled()
      expect(module.hot.accept).toBeCalled()
    })

    it('hydrates when in production does not accept hot module reloads', () => {
      const ReactDOM = require('react-dom')
      const importedComponent = require('react-imported-component')
      importedComponent.rehydrateMarks.mockImplementation(() => Promise.resolve()) // mock module.hot
      const module = {} // mock rehydrate function
      const hydrate = jest.fn() // mock options
      const options = {
        isProduction: true,
        module,
        document,
        hydrate
      } start(options)
      expect(ReactDOM.render).not.toBeCalled()
      expect(hydrate).toBeCalled()
    }) }) describe('#hydrate', () => {
    it('uses ReactDOM to hydrate given element with an app', () => {
      const ReactDOM = require('react-dom')
      const element = document.getElementById('app')
      const app = (<div></div>)
      const doHydrate = hydrate(app, element) expect(typeof doHydrate).toBe('function') doHydrate()
      expect(ReactDOM.hydrate).toBeCalledWith(app, element)
    })
  })})
```

ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿è¡Œæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ 100%è¦†ç›–`app`æ–‡ä»¶å¤¹ï¼Œé™¤äº†`app/imported.js`æ˜¯ä¸€ä¸ªç”Ÿæˆçš„æ–‡ä»¶ï¼Œæµ‹è¯•æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šåœ¨æœªæ¥ç‰ˆæœ¬ä¸­ç”Ÿæˆä¸åŒçš„æ–‡ä»¶ã€‚

è®©æˆ‘ä»¬æ›´æ–° jest é…ç½®ï¼Œä»è¦†ç›–ç‡ç»Ÿè®¡ä¸­å¿½ç•¥å®ƒï¼Œå¹¶æ£€æŸ¥ç»“æœã€‚

åœ¨`jest.config`æ·»åŠ :

```
"coveragePathIgnorePatterns": [
  "<rootDir>/app/imported.js",
  "/node_modules/"
]
```

ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿è¡Œ`npm run test`æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹ç»“æœã€‚

![](img/5788dcb1c7e89157a9dcf307ab11c3b3.png)[](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/c5fcfe9fdfb24d1708fb1d23b7126058d7b44fe4) [## test: client.js æµ‹è¯• Patrick let/streaming-SSR-react-styled-components @ C5 fcfe 9

### æµå¼ ssr ååº”é£æ ¼ç»„ä»¶ä¸åŒ…è£¹ã€‚è´¡çŒ®ç»™ Patrick let/streaming-SSR-react-styled-componentsâ€¦

github.com](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/c5fcfe9fdfb24d1708fb1d23b7126058d7b44fe4) 

æˆ‘æƒ³æŒ‡å‡ºçš„ä¸€ç‚¹æ˜¯ï¼Œå½“æˆ‘å¼€å‘æµ‹è¯•æ—¶ï¼Œæˆ‘é€šå¸¸ä½¿ç”¨â€œè§‚å¯Ÿâ€æ¨¡å¼æ¥è¿™æ ·åšï¼Œæ‰€ä»¥å½“æµ‹è¯•æ”¹å˜æ—¶ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨é‡æ–°è¿è¡Œã€‚

åº”ç”¨ç¨‹åºæµ‹è¯•å®Œæˆåï¼Œè®©æˆ‘ä»¬ç»§ç»­è®¨è®ºæœåŠ¡å™¨ã€‚

## æœåŠ¡å™¨æµ‹è¯•

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä¸€ä¸ªåº”ç”¨ç¨‹åºæ–‡ä»¶å’Œä¸€ä¸ªæœåŠ¡å™¨æ–‡ä»¶ç¼–å†™äº†æµ‹è¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬å·²ç»ä¸º`server/index.js`ç¼–å†™äº†æµ‹è¯•ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦æµ‹è¯•`server/lib`ä¸­å‰©ä½™çš„ä¸‰ä¸ªæ–‡ä»¶ã€‚

å…ˆè¯´`server/lib/client.js`:

```
import fs from 'fs'
import path from 'path'
import cheerio from 'cheerio'export const htmlPath = path.join(process.cwd(), 'dist', 'client', 'index.html')
export const rawHTML = fs.readFileSync(htmlPath).toString()export const parseRawHTMLForData = (template, selector = '#js-entrypoint') => {
  const $template = cheerio.load(template)
  let src = $template(selector).attr('src') return {
    src
  }
}const clientData = parseRawHTMLForData(rawHTML)const appString = '<div id="app">'
const splitter = '###SPLIT###'
const [startingRawHTMLFragment, endingRawHTMLFragment] = rawHTML
  .replace(appString, `${appString}${splitter}`)
  .split(splitter)export const getHTMLFragments = ({ drainHydrateMarks }) => {
  const startingHTMLFragment = `${startingRawHTMLFragment}${drainHydrateMarks}`
  return [startingHTMLFragment, endingRawHTMLFragment]
}
```

é¦–å…ˆï¼Œæˆ‘æ³¨æ„åˆ°æœ‰ä¸€å¤§å—ä»£ç ç”šè‡³æ²¡æœ‰åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œè¿™äº›ä»£ç æ¥è‡ªä»¥å‰æ”¾å¼ƒçš„ç­–ç•¥ã€‚ä» `export const parseRawHTMLForData`åˆ°`const clientData`çš„ä¸€åˆ‡ã€‚

æˆ‘å…ˆæŠŠå®ƒåˆ æ‰ã€‚ä»£ç è¶Šå°‘ï¼Œå­˜åœ¨ bug çš„åœ°æ–¹å°±è¶Šå°‘ã€‚è¿˜æœ‰å‡ ä¸ªæˆ‘ä»æœªä½¿ç”¨è¿‡çš„å¯¼å‡ºï¼Œå®ƒä»¬å¯ä»¥ä¿æŒæ¨¡å—ç§æœ‰ã€‚

ä»¥ä¸‹æ˜¯æ›´æ–°åçš„æ–‡ä»¶:

```
import fs from 'fs'
import path from 'path'const htmlPath = path.join(process.cwd(), 'dist', 'client', 'index.html')
const rawHTML = fs.readFileSync(htmlPath).toString()const appString = '<div id="app">'
const splitter = '###SPLIT###'
const [startingRawHTMLFragment, endingRawHTMLFragment] = rawHTML
  .replace(appString, `${appString}${splitter}`)
  .split(splitter)export const getHTMLFragments = ({ drainHydrateMarks }) => {
  const startingHTMLFragment = `${startingRawHTMLFragment}${drainHydrateMarks}`
  return [startingHTMLFragment, endingRawHTMLFragment]
}
```

çœ‹èµ·æ¥ä¸€ä¸ªæµ‹è¯•å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªè®¡åˆ’ä¸­æœ‰ä¸€ä¸ªå°é—®é¢˜:è¿™ä¸ªæ–‡ä»¶ä¾èµ–äºä¹‹å‰è¿è¡Œçš„æ„å»ºï¼Œå› ä¸ºå®ƒè¯»å…¥äº†ç”Ÿæˆçš„æ„å»ºã€‚

ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œè¿™æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰æ„å»ºå¥½çš„åº”ç”¨ç¨‹åºè¦å‘ˆç°ï¼Œä½ æ°¸è¿œä¸ä¼šå°è¯•åœ¨æœåŠ¡å™¨ä¸Šå‘ˆç°åº”ç”¨ç¨‹åºã€‚

è€ƒè™‘åˆ°è¿™ç§çº¦æŸï¼Œæˆ‘ä¼šè¯´è¿™æ˜¯å¯ä»¥çš„ï¼Œè€Œä¸”å¯èƒ½ä¸å€¼å¾—åŠªåŠ›é‡æ„ï¼Œå› ä¸ºæˆ‘ä»¬åªèƒ½ç¡®ä¿æˆ‘ä»¬çš„ç®¡é“è°ƒç”¨åœ¨æµ‹è¯•ä¹‹å‰æ„å»ºã€‚å¦‚æœæˆ‘ä»¬æƒ³æœ‰çœŸæ­£çº¯ç²¹çš„å•å…ƒéš”ç¦»ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè€ƒè™‘æ›´å¤šçš„é‡æ„ï¼Œå› ä¸ºä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºæ˜¯ SSR çš„ä¾èµ–ï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¼šè¢«å˜²ç¬‘ã€‚å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨å®é™…çš„æ„å»ºå¯èƒ½æ›´æœ‰ç”¨ã€‚åœ¨ç¼–å†™æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæ‚¨ä¼šç»å¸¸é‡åˆ°è¿™æ ·çš„æƒè¡¡ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢æ˜¯å…¨é¢è¦†ç›–æœ¬æ¨¡å—çš„æµ‹è¯•:

```
import { getHTMLFragments } from 'server/lib/client.js'describe('client', () => {
  it('exists', () => {
    const drainHydrateMarks = '<!-- mock hydrate marks -->'
    const [start, end] = getHTMLFragments({ drainHydrateMarks })
    expect(start).toContain('<head>')
    expect(start).toContain(drainHydrateMarks)
    expect(end).toContain('script id="js-entrypoint"')
  })
})
```

ä»¥åŠæäº¤:[ä¿®å¤:åˆ é™¤è§£ææ¨¡æ¿](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/792da703e246726f63b04390588251dbccbfe910)æœªä½¿ç”¨çš„ä»£ç ï¼Œ[æµ‹è¯•:æœåŠ¡å™¨/åº“/å®¢æˆ·ç«¯æµ‹è¯•](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/e757402d7c27ff59c46ec7d733ef0d4bb0323f26)ã€‚

æ¥ä¸‹æ¥ï¼Œ`server/lib/server.js`éå¸¸å°ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒæ•²å‡ºæ¥ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„ä»£ç ï¼Œæé†’ä½ ä¸€ä¸‹ï¼Œæˆ–è€…å¦‚æœä½ åˆšåˆšåŠ å…¥æˆ‘ä»¬:

```
import express from 'express'export const server = express()
export const serveStatic = express.static
```

æµ‹è¯•æ˜¯:

```
import express from 'express'
import { server, serveStatic } from 'server/lib/server.js'describe('server/lib/server', () => {
  it('should provide server APIs to use', () => {
    expect(server).toBeDefined()
    expect(server.use).toBeDefined()
    expect(server.get).toBeDefined()
    expect(server.listen).toBeDefined()
    expect(serveStatic).toEqual(express.static)
  })
})
```

çœ‹èµ·æ¥æˆ‘ä»¬åŸºæœ¬ä¸Šåªæ˜¯æŠŠæ‰€æœ‰çš„è´£ä»»éƒ½æ¨ç»™äº† expressï¼Œæˆ‘ä»¬å¸Œæœ› express æä¾›è¿™ä¸ªåˆåŒï¼Œæˆ‘ä»¬åªéœ€ç®€å•åœ°ç¡®ä¿å®ƒæä¾›ï¼Œè¶…å‡ºè¿™ä¸ªèŒƒå›´å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ã€‚

æœ€åï¼Œæˆ‘ä»¬åªå‰©ä¸‹ä¸€ä¸ªæ–‡ä»¶éœ€è¦æµ‹è¯•:`server/lib/ssr.js`ã€‚

è¿™æ˜¯æˆ‘ä»¬çš„`ssr`æ¨¡å—:

```
import React from 'react'
import { renderToNodeStream } from 'react-dom/server'
import { HelmetProvider } from 'react-helmet-async'
import { StaticRouter } from 'react-router-dom'
import { ServerStyleSheet } from 'styled-components'
import { printDrainHydrateMarks } from 'react-imported-component'
import log from 'llog'
import through from 'through'
import App from '../../app/App'
import { getHTMLFragments } from './client'
// import { getDataFromTree } from 'react-apollo';export default (req, res) => {
  const context = {}
  const helmetContext = {} const app = (
    <HelmetProvider context={helmetContext}>
      <StaticRouter location={req.originalUrl} context={context}>
        <App />
      </StaticRouter>
    </HelmetProvider>
  ) try {
    // If you were using Apollo, you could fetch data with this
    // await getDataFromTree(app); const sheet = new ServerStyleSheet()
    const stream = sheet.interleaveWithNodeStream(
      renderToNodeStream(sheet.collectStyles(app))
    ) if (context.url) {
      res.redirect(301, context.url)
    } else {
      const [startingHTMLFragment, endingHTMLFragment] = getHTMLFragments({
        drainHydrateMarks: printDrainHydrateMarks()
      })
      res.status(200)
      res.write(startingHTMLFragment)
      stream
        .pipe(
          through(
            function write (data) {
              this.queue(data)
            },
            function end () {
              this.queue(endingHTMLFragment)
              this.queue(null)
            }
          )
        )
        .pipe(res)
    }
  } catch (e) {
    log.error(e)
    res.status(500)
    res.end()
  }
}
```

æœ‰ç‚¹é•¿ï¼Œè¦æ‰§è¡Œçš„è·¯å¾„ä¹Ÿä¸å¤šã€‚æˆ‘ç¡®å®æƒ³åšä¸€äº›å°çš„é‡æ„ï¼Œè®©éš”ç¦»å˜å¾—æ›´å®¹æ˜“ä¸€äº›ï¼Œæ¯”å¦‚æå–é€»è¾‘ä»¥å°†åº”ç”¨ç¨‹åºç”Ÿæˆåˆ°ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°ä¸­ï¼Œå¹¶ä½¿ç”¨ partial application æ¥æ³¨å…¥åº”ç”¨ç¨‹åºæµæ¸²æŸ“å™¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è½»æ¾åœ°æ¨¡æ‹Ÿä¸€äº›é‡å®šå‘ã€‚

å¦å¤–`write`å’Œ`end`æœ‰ç‚¹éš¾åˆ°è¾¾ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨éƒ¨åˆ†åº”ç”¨å°†å®ƒä»¬æ‹‰å¾—æ›´é«˜ã€‚

è¿™æ˜¯ä¸€ä¸ªæ›´æ–°çš„ç‰ˆæœ¬:

```
import React from 'react'
import { renderToNodeStream } from 'react-dom/server'
import { HelmetProvider } from 'react-helmet-async'
import { StaticRouter } from 'react-router-dom'
import { ServerStyleSheet } from 'styled-components'
import { printDrainHydrateMarks } from 'react-imported-component'
import log from 'llog'
import through from 'through'
import App from '../../app/App'
import { getHTMLFragments } from './client'
// import { getDataFromTree } from 'react-apollo';**const getApplicationStream = (originalUrl, context) => {**
  const helmetContext = {}
  const app = (
    <HelmetProvider context={helmetContext}>
      <StaticRouter location={originalUrl} context={context}>
        <App />
      </StaticRouter>
    </HelmetProvider>
  ) const sheet = new ServerStyleSheet()
  return sheet.interleaveWithNodeStream(
    renderToNodeStream(sheet.collectStyles(app))
  )
}**export function write (data) {
  this.queue(data)
}**// partial application with ES6 is quite succinct
// it just means a function which returns another function
// which has access to values from a closure
**export const end = endingHTMLFragment =>
  function end () {
    this.queue(endingHTMLFragment)
    this.queue(null)
  }****export const ssr = getApplicationStream => (req, res) => {**
  try {
    // If you were using Apollo, you could fetch data with this
    // await getDataFromTree(app); const context = {}
    const stream = getApplicationStream(req.originalUrl, context) if (context.url) {
      return res.redirect(301, context.url)
    } const [startingHTMLFragment, endingHTMLFragment] = getHTMLFragments({
      drainHydrateMarks: printDrainHydrateMarks()
    }) res.status(200)
    res.write(startingHTMLFragment)
    stream.pipe(through(write, end(endingHTMLFragment))).pipe(res)
  } catch (e) {
    log.error(e)
    res.status(500)
    res.end()
  }
**}****const defaultSSR = ssr(getApplicationStream)****export default defaultSSR**
```

è¿™é‡Œæœ‰ä¸€ä¸ªé“¾æ¥æ¥çœ‹çœ‹ Github ä¸­çš„åŒºåˆ«:[è‹¦å·®äº‹:é‡æ„ ssr å°†å…¶åˆ†è§£/ä½¿å…¶æ›´å®¹æ˜“é˜…è¯»](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/8d91c3d3a07bcb1949df6cc0f4d8b1fac3a6d2ea)ï¼Œä»¥åŠ[è‹¦å·®äº‹:æ›´å¤šåœ°é‡æ„ SSR](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/a6cceddd929676799f0c3ffdc7ae8862f5282360)ã€‚

ç°åœ¨è®©æˆ‘ä»¬å†™ä¸€äº›æµ‹è¯•ã€‚æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªæ–‡ä»¶ä¸“é—¨ä¸º node è®¾ç½® jest-environmentï¼Œå¦åˆ™ styled-components éƒ¨åˆ†å°†ä¸èµ·ä½œç”¨ã€‚

```
/**
 * [@jest](http://twitter.com/jest)-environment node
 */
import defaultSSR, { ssr, write, end } from 'server/lib/ssr.js'jest.mock('llog')const mockReq = {
  originalUrl: '/'
}const mockRes = {
  redirect: jest.fn(),
  status: jest.fn(),
  end: jest.fn(),
  write: jest.fn(),
  on: jest.fn(),
  removeListener: jest.fn(),
  emit: jest.fn()
}describe('server/lib/ssr.js', () => {
  describe('ssr', () => {
    it('redirects when context.url is set', () => {
      const req = Object.assign({}, mockReq)
      const res = Object.assign({}, mockRes)
      const getApplicationStream = jest.fn((originalUrl, context) => {
        context.url = '/redirect'
      })
      const doSSR = ssr(getApplicationStream) expect(typeof doSSR).toBe('function')
      doSSR(req, res)
      expect(res.redirect).toBeCalledWith(301, '/redirect')
    }) it('catches error and logs before returning 500', () => {
      const log = require('llog')
      const req = Object.assign({}, mockReq)
      const res = Object.assign({}, mockRes)
      const getApplicationStream = jest.fn((originalUrl, context) => {
        throw new Error('test')
      })
      const doSSR = ssr(getApplicationStream)
      expect(typeof doSSR).toBe('function')
      doSSR(req, res)
      expect(log.error).toBeCalledWith(Error('test'))
      expect(res.status).toBeCalledWith(500)
      expect(res.end).toBeCalled()
    })
  }) describe('defaultSSR', () => {
    it('renders app with default SSR', () => {
      const req = Object.assign({}, mockReq)
      const res = Object.assign({}, mockRes)
      defaultSSR(req, res)
      expect(res.status).toBeCalledWith(200)
      expect(res.write.mock.calls[0][0]).toContain('<!DOCTYPE html>')
      expect(res.write.mock.calls[0][0]).toContain(
        'window.___REACT_DEFERRED_COMPONENT_MARKS'
      )
    })
  }) describe('#write', () => {
    it('write queues data', () => {
      const context = {
        queue: jest.fn()
      }
      const buffer = new Buffer.from('hello')
      write.call(context, buffer)
      expect(context.queue).toBeCalledWith(buffer)
    })
  }) describe('#end', () => {
    it('end queues endingFragment and then null to end stream', () => {
      const context = {
        queue: jest.fn()
      }
      const endingFragment = '</html>'
      const doEnd = end(endingFragment)
      doEnd.call(context)
      expect(context.queue).toBeCalledWith(endingFragment)
      expect(context.queue).toBeCalledWith(null)
    })
  })
})
```

ç”±äºè¿™ä¸ªæ–‡ä»¶æ¯”å…¶ä»–ä¸€äº›æ–‡ä»¶ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„æµ‹è¯•æ¥æµ‹è¯•æ‰€æœ‰çš„åˆ†æ”¯ã€‚ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæ¯ä¸ªå‡½æ•°éƒ½åŒ…è£…åœ¨è‡ªå·±çš„æè¿°å—ä¸­ã€‚

ä¸‹é¢æ˜¯ Github ä¸Šçš„æäº¤:[æµ‹è¯•:ssr å•å…ƒæµ‹è¯•](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/bc6ce3cdd9d82be7fbf58538f9af5f6bf4a44eec)ã€‚

ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬æœ‰ 100%çš„è¦†ç›–ç‡ï¼

![](img/2aecdbde1fcae5b9d67d8b0e84960a2b.png)

æœ€åï¼Œåœ¨ç»“æŸä¹‹å‰ï¼Œæˆ‘å°†å¯¹æˆ‘çš„`jest.config`åšä¸€ä¸ªå°å°çš„ä¿®æ”¹ï¼Œä»¥å®ç° 100%çš„è¦†ç›–ç‡ã€‚ä¿æŒè¦†ç›–ç‡æ¯”ç¬¬ä¸€æ¬¡è·å¾—è¦†ç›–ç‡è¦å®¹æ˜“å¾—å¤šã€‚æˆ‘ä»¬æµ‹è¯•çš„è®¸å¤šæ¨¡å—å‡ ä¹ä¸ä¼šæ”¹å˜ã€‚

```
 "coverageThreshold": {
    "global": {
      "branches": 100,
      "functions": 100,
      "lines": 100,
      "statements": 100
    }
  },
```

æå®šäº†ã€‚ä¸‹é¢æ˜¯ Github ä¸Šçš„æ‰¿è¯º:[è‹¦å·®äº‹:è¦æ±‚ 100%è¦†ç›–](https://github.com/patrickleet/streaming-ssr-react-styled-components/commit/1d00345beacf6141062faf94fcc929e2dacb5d8b)ã€‚

# ç»“è®º

æœ¬æ–‡çš„ç›®æ ‡æ˜¯å±•ç¤ºé‡æ„ä»£ç æ‰€éœ€çš„æŠ€æœ¯ï¼Œæˆ–è€…ä½¿ç”¨æ¨¡æ‹Ÿå’Œä¾èµ–æ³¨å…¥æ¥éš”ç¦»å•å…ƒï¼Œä½¿éš¾ä»¥æµ‹è¯•çš„ä»£ç å˜å¾—å®¹æ˜“ï¼Œå¹¶è®¨è®ºè¾¾åˆ° 100%è¦†ç›–ç‡çš„ä¸€äº›ä¼˜ç‚¹ã€‚æ­¤å¤–ï¼Œä»èµ·ç‚¹ä½¿ç”¨ TDD è¦å®¹æ˜“å¾—å¤šã€‚

æˆ‘åšä¿¡ï¼Œå¦‚æœå¾ˆéš¾è¾¾åˆ° 100%çš„è¦†ç›–ç‡ï¼Œé‚£æ˜¯å› ä¸ºä»£ç éœ€è¦é‡æ„ã€‚

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ŒE2E æµ‹è¯•å¯¹æŸäº›äº‹æƒ…æ¥è¯´æ˜¯æ›´å¥½çš„æµ‹è¯•ã€‚åœ¨æ­¤åŸºç¡€ä¸Šçš„ä¸€ä¸ª [Cypress.io](https://medium.com/u/47c842e55929?source=post_page-----900b83d20d3d--------------------------------) å¥—ä»¶å¯ä»¥åŠ è½½åº”ç”¨ç¨‹åºå¹¶ç‚¹å‡»ï¼Œè¿™å°†å¤§å¤§å¢åŠ æˆ‘ä»¬çš„ä¿¡å¿ƒã€‚

æˆ‘ç›¸ä¿¡åœ¨ä¸€ä¸ªæ‹¥æœ‰ 100%è¦†ç›–ç‡çš„ä»£ç åº“ä¸­å·¥ä½œï¼Œåœ¨å¢åŠ ä½ å¯¹æ¯ä¸ªç‰ˆæœ¬çš„ä¿¡å¿ƒæ–¹é¢åšå¾—å¾ˆå¥½ï¼Œå› æ­¤å¢åŠ äº†ä½ åšå‡ºå’Œæ£€æµ‹çªç ´æ€§å˜åŒ–çš„é€Ÿåº¦ã€‚

å’Œå¾€å¸¸ä¸€æ ·ï¼Œå¦‚æœä½ è§‰å¾—è¿™å¾ˆæœ‰ç”¨ï¼Œè¯·ç•™ä¸‹ä¸€äº›æŒå£°ï¼Œå…³æ³¨æˆ‘ï¼Œåœ¨ GitHub é¡¹ç›®[ä¸Šç•™ä¸‹ä¸€é¢—æ˜Ÿ](https://github.com/patrickleet/streaming-ssr-react-styled-components)ï¼Œå’Œ/æˆ–åœ¨ç¤¾äº¤ç½‘ç»œä¸Šåˆ†äº«ï¼

åœ¨å³å°†åˆ°æ¥çš„ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„ docker æ–‡ä»¶ï¼Œå¹¶æ¢ç´¢å¦‚ä½•ä»…ä½¿ç”¨å¦ä¸€ä¸ª docker æ–‡ä»¶å°±å¯ä»¥å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ‰“åŒ…ä¸ºä¸€ä¸ªä½¿ç”¨ Nginx çš„é™æ€ç«™ç‚¹ï¼Œä»¥åŠè¿™ä¸¤ç§æ–¹æ³•ä¹‹é—´çš„ä¸€äº›æƒè¡¡ã€‚

æœ€å¥½ï¼Œ[æé›…è¾¾Â·æ–¯ç§‘ç‰¹](https://twitter.com/pat_scott)

æŸ¥çœ‹æœ¬ç³»åˆ—çš„å…¶ä»–æ–‡ç« ï¼è¿™æ˜¯ç¬¬å››éƒ¨åˆ†ã€‚

[](https://hackernoon.com/move-over-next-js-and-webpack-ba367f07545) [## ç¬¬ 1 éƒ¨åˆ†:è®¨è®º Next.js å’Œ WebpackğŸ¤¯

### ç®€å•æµæœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)ååº”+æ ·å¼-ç»„ä»¶ä¸åŒ…è£¹

hackernoon.com](https://hackernoon.com/move-over-next-js-and-webpack-ba367f07545) [](https://hackernoon.com/a-better-way-to-develop-node-js-with-docker-cd29d3a0093) [## ç¬¬ 2 éƒ¨åˆ†:ç”¨ Docker å¼€å‘ Node.js çš„æ›´å¥½æ–¹æ³•

### å¹¶ä¿æŒæ‚¨çš„çƒ­ä»£ç é‡è½½

hackernoon.com](https://hackernoon.com/a-better-way-to-develop-node-js-with-docker-cd29d3a0093) [](https://hackernoon.com/enforcing-code-quality-for-node-js-c3b837d7ae17) [## ç¬¬ 3 éƒ¨åˆ†:åŠ å¼º Node.js çš„ä»£ç è´¨é‡

### ä½¿ç”¨æ—æŒºã€æ ¼å¼åŒ–å’Œå¸¦æœ‰ä»£ç è¦†ç›–çš„å•å…ƒæµ‹è¯•æ¥å®æ–½è´¨é‡æ ‡å‡†

hackernoon.com](https://hackernoon.com/enforcing-code-quality-for-node-js-c3b837d7ae17) [](https://hackernoon.com/a-tale-of-two-docker-multi-stage-build-layers-85348a409c84) [## ç¬¬ 5 éƒ¨åˆ†:ä¸¤å±‚(Docker å¤šé˜¶æ®µæ„å»º)çš„æ•…äº‹

### Node.js çš„ç”Ÿäº§å°±ç»ª docker æ–‡ä»¶

hackernoon.com](https://hackernoon.com/a-tale-of-two-docker-multi-stage-build-layers-85348a409c84)