# Bitbucket + Bitrise:ä¸º iOS åº”ç”¨é…ç½®æŒç»­é›†æˆ

> åŸæ–‡ï¼š<https://medium.com/hackernoon/bitbucket-bitrise-configuring-continuous-integration-for-an-ios-app-8974474bca6b>

è¿™æ˜¯ Ivan Parfenchuk ä¸º Bitbucket æ’°å†™çš„å®¢åº§åšæ–‡ã€‚Ivan æ˜¯ä¸€åç‹¬ç«‹çš„ iOS å’Œ Ruby å¼€å‘äººå‘˜ï¼Œçƒ­è¡·äºæ„å»ºæ„‰å¿«çš„ä½“éªŒã€‚å’Œä»–åœ¨ Twitter ä¸Šè”ç³»[*@ gazebushka*](https://twitter.com/gazebushka)*ã€‚*

å½“ iOS åº”ç”¨ç¨‹åºå¼€å§‹å¢é•¿æ—¶ï¼Œåœ¨æŸä¸ªæ—¶å€™ï¼Œæ‹¥æœ‰ä¸€ä¸ªå¿«é€Ÿçš„å¼€å‘-å‘å¸ƒ-æµ‹è¯•åé¦ˆå¾ªç¯å˜å¾—è‡³å…³é‡è¦ã€‚æ‚¨å¯ä»¥é€šè¿‡æ‰‹åŠ¨å®Œæˆæ‰€æœ‰å·¥ä½œæ¥åˆ›å»ºè¿™ä¸ªå¾ªç¯ï¼Œä½†æ˜¯å¦‚æœæ‚¨ä½¿ç”¨æŒç»­é›†æˆ(CI)å·¥å…·ï¼Œå®ƒä¼šæ›´å¿«æ›´é«˜çº§ã€‚

ä½¿ç”¨ CI å·¥å…·ï¼Œæ‚¨å¯ä»¥æ„å»ºå‘å¸ƒçš„å†å²ï¼Œå¹¶å¿«é€ŸæŸ¥çœ‹å“ªä¸ªæ„å»ºåŒ…å«äº†ä»€ä¹ˆã€‚æ‚¨å¯ä»¥å¯¹æ¯ä¸ªæ„å»ºè‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼Œå¹¶æ•æ‰ä¸€äº›ä¸å¯é¿å…çš„é”™è¯¯ã€‚æ‚¨å¯ä»¥åœ¨å‘è¡Œè¯´æ˜ä¸­ä¿æŒä¸€è‡´æ€§ã€‚æ‚¨è¿˜å¯ä»¥ç®€åŒ–æ‚¨çš„å‘å¸ƒå‘¨æœŸï¼Œä»è€Œè‡ªåŠ¨åŒ–æ‚¨çš„æ¸…å•ã€‚

å¬èµ·æ¥æœ‰è¶£å—ï¼Ÿè®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ Bitbucket Webhooksã€Bitrise å’Œ fastlane æ¥æ„å»ºè¿™ä¸ªåé¦ˆå›è·¯ã€‚

# éƒ¨ç½²æµç¨‹

æˆ‘ä»¬å°†ç”¨äºæŒç»­é›†æˆçš„æµç¨‹å¦‚ä¸‹æ‰€ç¤º:

1.  åœ¨ Bitbucket ä¸­åˆ›å»ºå’Œåˆå¹¶æ‹‰è¯·æ±‚
2.  [Bitbucket](https://bitbucket.org/product) å¯¹ Bitrise æ‰§è¡Œâ€œweb hookâ€HTTP è¯·æ±‚
3.  [Bitrise](https://www.bitrise.io/) å¼€å§‹æ„å»ºæµç¨‹å¹¶å¯åŠ¨ fastlane
4.  [fastlane](https://fastlane.tools/) æ„å»ºåº”ç”¨å¹¶å°†å…¶å‘é€è‡³ App Store Connect
5.  App Store Connect å¤„ç†æ„å»ºï¼Œå¹¶åœ¨ TestFlight ä¸­å¯ç”¨

# Bitbucket Webhooks å’Œ git åˆ†æ”¯æ¨¡å‹

æ¯æ¬¡éƒ¨ç½²éƒ½ä»æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‹‰å–è¯·æ±‚å¼€å§‹ã€‚

å‡è®¾æ‚¨çš„å›¢é˜Ÿæ­£åœ¨ä½¿ç”¨ä¸» git åˆ†æ”¯æ¥å¤„ç†å¤„äºå¯å‘å¸ƒçŠ¶æ€çš„ä»£ç ã€‚å®ƒè¿˜é€šè¿‡å°†è¿™ä¸ªä¸»åˆ†æ”¯åˆå¹¶åˆ°å‘å¸ƒåˆ†æ”¯æ¥ç”Ÿæˆæ–°çš„å‘å¸ƒã€‚

ä»¥ä¸‹éƒ¨åˆ†æè¿°äº†å¦‚ä½•æ‰‹åŠ¨åˆ›å»º Webhookã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä½¿ç”¨ Bitriseï¼Œå®ƒå¯ä»¥è‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ª Webhookï¼Œæ‰€ä»¥ï¼Œè¯·éšæ„è·³åˆ° Bitrise éƒ¨åˆ†ã€‚

# æ‰‹åŠ¨ Webhook é…ç½®

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬é…ç½® Bitbucket Webhooksï¼Œä»¥ä¾¿æ¯å½“æœ‰äººæ¨é€é‡Šæ”¾åˆ†æ”¯æˆ–åˆå¹¶ Pull è¯·æ±‚ä»¥é‡Šæ”¾åˆ†æ”¯æ—¶ï¼Œéƒ½ä¼šè§¦å‘ Webhookã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¯·è¿›å…¥æ‚¨çš„ Bitbucket å­˜å‚¨åº“ï¼Œç„¶åå•å‡»ä¾§è¾¹èœå•ä¸­çš„â€œè®¾ç½®â€ã€‚ç„¶åç‚¹å‡»â€œå·¥ä½œæµç¨‹â€éƒ¨åˆ†çš„â€œWebhooksâ€ï¼Œç„¶åç‚¹å‡»â€œæ·»åŠ  webhookâ€

å¡«å†™æ ‡é¢˜ã€URL(è§ä¸‹æ–‡)ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸ºæ´»åŠ¨ï¼Œå¹¶ä¸ºè§¦å‘å™¨é€‰æ‹©â€œä»å®Œæ•´çš„è§¦å‘å™¨åˆ—è¡¨ä¸­é€‰æ‹©â€ã€‚æˆ‘ä»¬å°†ä½¿ç”¨çš„è§¦å‘å™¨æ˜¯:

1.  å­˜å‚¨åº“:æ¨é€
2.  æ‹‰å¼è¯·æ±‚:åˆ›å»ºã€æ›´æ–°

è¦è·å–æˆ‘ä»¬çš„ Webhook çš„ URL:

1.  å» Bitriseï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åº
2.  æ‰“å¼€ä»ªè¡¨æ¿->æ‚¨çš„åº”ç”¨->ä»£ç é€‰é¡¹å¡
3.  æ»šåŠ¨åˆ° Incoming Webhooks éƒ¨åˆ†ï¼Œç„¶åå•å‡»æ‰‹åŠ¨è®¾ç½®ã€‚
4.  é€‰æ‹©â€œBitbucket Webhooksâ€å¹¶å¤åˆ¶ Webhook URL

![](img/b074fa1348c85e3047fdd610a3dac9d7.png)

# Bitrise å’Œè‡ªåŠ¨ Webhook é…ç½®

Bitrise æ˜¯ä¸€ä¸ªæŒç»­é›†æˆçš„å¹³å°ã€‚æ‚¨å¯ä»¥åœ¨å…¶ä¸­é…ç½®ä¸åŒçš„éƒ¨ç½²â€œå·¥ä½œæµâ€ï¼Œå¹¶è®© Bitrise æœåŠ¡å™¨æ„å»ºå’Œå‘å¸ƒæ‚¨çš„åº”ç”¨ç¨‹åºã€‚ä¸‹é¢æ˜¯ä¸ºæˆ‘ä»¬çš„ CI è®¾ç½®åˆ›å»ºæ–°éƒ¨ç½²å·¥ä½œæµçš„æ­¥éª¤ã€‚

1.  é¦–å…ˆåœ¨ Bitrise æ³¨å†Œï¼Œè¿›å…¥ä»ªè¡¨ç›˜ï¼Œç‚¹å‡»â€œæ·»åŠ æ–°åº”ç”¨â€
2.  å¦‚æœæ‚¨å¸Œæœ›æ‚¨çš„é…ç½®å’Œæ—¥å¿—ä¿æŒç§æœ‰ï¼Œè¯·é€‰æ‹©â€œç§æœ‰â€
3.  é€‰æ‹© Bitbucket å¹¶å°†å…¶è¿æ¥åˆ°æ‚¨çš„å¸æˆ·
4.  ç‚¹æŒ‰â€œè‡ªåŠ¨æ·»åŠ  SSH å¯†é’¥â€æˆ–æ‰‹åŠ¨é…ç½® SSH è®¿é—®
5.  åœ¨â€œé€‰æ‹©åˆ†è¡Œâ€æ­¥éª¤ä¸­ï¼Œè¾“å…¥â€œreleaseâ€ä½œä¸ºåˆ†è¡Œåç§°
6.  åœ¨é¡¹ç›®æ„å»ºé…ç½®ä¸­é€‰æ‹©â€œå¿«é€Ÿé€šé“â€ï¼Œæ£€æŸ¥æµªå­é€šé“æ˜¯å¦è®¾ç½®ä¸ºâ€œios ç‰ˆæœ¬â€ã€‚
7.  é€‰æ‹©æ‚¨é€šå¸¸ç”¨æ¥æ„å»ºåº”ç”¨ç¨‹åºçš„å †æ ˆæˆ–æœ€æ–°å¯ç”¨çš„ Xcode/macOSï¼Œç„¶åç‚¹æŒ‰â€œç¡®è®¤â€ã€‚
8.  åœ¨æœ€åä¸€æ­¥â€œWebhook è®¾ç½®â€ä¸­ï¼Œç‚¹å‡»â€œä¸ºæˆ‘æ³¨å†Œ Webhookâ€

æœ€åä¸€æ­¥åœ¨ Bitbucket ä¸­åˆ›å»ºäº†ä¸€ä¸ª Webhookï¼Œæ‰€ä»¥æ‚¨ä¸éœ€è¦æ‰‹åŠ¨åšä»»ä½•äº‹æƒ…ã€‚ä½ å¯ä»¥å» Bitbucket repositoryï¼Œåœ¨ Settings -> Webhooks ä¸­æ£€æŸ¥ Webhook çš„é…ç½®ã€‚

åœ¨æˆ‘ä»¬çš„è®¾ç½®ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ fastlane æ„å»ºåº”ç”¨ç¨‹åºå¹¶å°†å…¶å‘å¸ƒåˆ° App Store Connectã€‚

# æµªå­æ„å‹

æµªå­æ˜¯ä¸€å¥—è‡ªåŠ¨åŒ–å¼€å‘å’Œå‘å¸ƒè¿‡ç¨‹çš„å·¥å…·ã€‚

æŒ‰ç…§æœ¬æŒ‡å—å®‰è£… fastlane: [è®¾ç½®â€” fastlane æ–‡æ¡£](https://docs.fastlane.tools/getting-started/ios/setup)

ç®€è€Œè¨€ä¹‹ï¼Œæ‚¨éœ€è¦å®‰è£… Xcode å¼€å‘å·¥å…·:

```
xcode-select --install
```

ç„¶åé€šè¿‡ RubyGems å®‰è£… fastlane

```
sudo gem install fastlane -NV
```

æˆ–è€…é€šè¿‡ brew:

```
brew cask install fastlane
```

ç„¶ååœ¨ç»ˆç«¯æ‰“å¼€ä½  app çš„å·¥ä½œç›®å½•ï¼Œåˆå§‹åŒ– fastlaneã€‚

```
cd /path/to/your/app 
fastlane init
```

é€‰æ‹©â€œ3ã€‚ğŸš€è‡ªåŠ¨åŒ–åº”ç”¨å•†åº—åˆ†å‘â€

ç„¶åæŒ‰ç…§é…ç½®è¦æ±‚è¿›è¡Œæ“ä½œã€‚æµªå­å¯ä»¥ä¸ºæ‚¨åˆ›å»ºå’Œé…ç½®æ–°çš„åº”ç”¨ç¨‹åº Idï¼Œå¹¶åˆ›å»ºä¸€ä¸ªç¤ºä¾‹éƒ¨ç½²â€œé€šé“â€Lane åªæ˜¯å®ŒæˆæŸäº›åœºæ™¯æ‰€éœ€çš„æ­¥éª¤çš„é›†åˆã€‚

ä¸€æ—¦é…ç½®å®Œæˆï¼Œè®©æˆ‘ä»¬æ‰“å¼€å·²ç»åˆ›å»ºçš„ Fastfile å¹¶é…ç½®æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªéƒ¨ç½²è„šæœ¬ã€‚æµªå­æœ‰ä¸€å¤§å¥—è‡ªåŠ¨åŒ–å„ç§è¿‡ç¨‹çš„å·¥å…·ï¼Œæ¯”å¦‚ä»£ç ç­¾åã€ä¸Šä¼ æˆªå›¾ã€è¿è¡Œæµ‹è¯•ç­‰ç­‰ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å°†ä»ä¸€ä¸ªç®€å•çš„è®¾ç½®å¼€å§‹:

```
default_platform(:ios) platform :ios do   
  desc "Push a new release build to the App Store"   
  lane :release do     
    build_app(scheme: "CITest")     
    upload_to_app_store(force: true, skip_metadata: true, skip_screenshots: true)   
  end 
end
```

â€œé‡Šæ”¾â€è½¦é“å°†

1.  æ‰§è¡Œé¡¹ç›® build_app çš„æ„å»º(scheme:â€œCITestâ€)
2.  å°†ç”Ÿæˆçš„ ipa æ–‡ä»¶ä¸Šä¼ åˆ° App Store Connect upload _ to _ App _ Storeã€‚åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†è·³è¿‡æµªå­å…ƒæ•°æ®ä¸Šä¼ ã€‚

æ‚¨å¯ä»¥é€šè¿‡åœ¨â€œç»ˆç«¯â€ä¸­æ‰“å¼€é¡¹ç›®ç›®å½•å¹¶è¿è¡Œ fastlane release æ¥æµ‹è¯•æ‚¨çš„è®¾ç½®:

```
cd /path/to/your/app/directory 
fastlane release
```

# ä»£ç ç­¾å

å¦‚æœæ‚¨å‘ç°ä»£ç ç­¾åæœ‰é—®é¢˜ï¼Œè¯·ä»è¿™é‡Œå¼€å§‹:[æ•…éšœæ’é™¤â€”å¿«é€Ÿé€šé“æ–‡æ¡£](https://docs.fastlane.tools/codesigning/troubleshooting)ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ fastlane match æ¥ç®¡ç†ä»£ç ç­¾åï¼Œä½†æ˜¯è¦å°å¿ƒ:å¦‚æœæ‚¨å·²ç»ç”Ÿæˆäº†è¯ä¹¦å’Œé¢„ç½®æè¿°æ–‡ä»¶ï¼Œmatch å¯èƒ½ä¼šå‡ºé”™ã€‚ç„¶è€Œï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„è®¾ç½®ï¼Œæˆ–è€…ä½ ä¸å¤ªå…³å¿ƒç°æœ‰çš„é…ç½®æ–‡ä»¶ï¼Œmatch å°†å¤§å¤§åŠ å¿«é€Ÿåº¦ã€‚

æˆ‘ä»¬å°†åœ¨ç¤ºä¾‹ä¸­ä½¿ç”¨å¿«é€Ÿé€šé“åŒ¹é…:

```
cd /path/to/your/app/directory 
fastlane match development 
fastlane match adhoc 
fastlane match appstore
```

ç„¶åæ‰“å¼€ Xcodeï¼Œå…³é—­è‡ªåŠ¨ä»£ç ç­¾åï¼Œé€‰æ‹© match ç”Ÿæˆçš„é¢„ç½®æè¿°æ–‡ä»¶ã€‚

ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å°† match æ·»åŠ åˆ°æˆ‘ä»¬çš„ Fastfile:

```
default_platform(:ios)

platform :ios do 
  desc "Push a new release build to the App Store" 
  lane :release do 
      match(type: "appstore", readonly: true) 
    build_app(scheme: "CITest") 
    upload_to_app_store(force: true, skip_metadata: true, skip_screenshots: true) 
  end 
end
```

# å®Œæˆ Bitrise è®¾ç½®

![](img/6187b8b794becf490e3efcc6f4453180.png)

Bitrise æ­£åœ¨å…¶æœåŠ¡å™¨ä¸Šæ„å»ºè¯¥é¡¹ç›®ï¼Œè¿™äº›æœåŠ¡å™¨ä¸Šæ²¡æœ‰ä»£ç ç­¾åå’Œä¸Šä¼ åº”ç”¨ç¨‹åºåˆ° App Store Connect æ‰€éœ€çš„ä»»ä½•å¯†ç å’Œå‡­æ®ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åˆ†äº«å…¶ä¸­ä¸€äº›ï¼Œç¡®åˆ‡åœ°è¯´æ˜¯è¿™ä¸¤ä¸ª:

1.  App Store Connect ç”¨æˆ·çš„ç™»å½•å/å¯†ç 
2.  è§£å¯†åŒ¹é…å­˜å‚¨åº“çš„å¯†ç (å¦‚æœä½¿ç”¨åŒ¹é…)

App Store Connect ç”¨æˆ·ä¸å¿…æ˜¯æ‚¨ç”¨æ¥æ§åˆ¶åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ã€‚æ‚¨å¯ä»¥åœ¨ App Store Connect ä¸­åˆ›å»ºæ–°ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·åªèƒ½è®¿é—®æ‚¨è‡ªåŠ¨åŒ–çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”è‡³å°‘æ‹¥æœ‰å¼€å‘äººå‘˜è§’è‰²ã€‚

ä¸€æ—¦ä½ è®¾ç½®äº†æ–°çš„åº”ç”¨å•†åº—è¿æ¥ç”¨æˆ·ï¼Œå‰å¾€ Bitriseï¼Œæ‰“å¼€å·¥ä½œæµç¼–è¾‘å™¨æ ‡ç­¾ï¼Œç„¶åç§˜å¯†ã€‚æ·»åŠ ä¸¤ä¸ªæ–°ç§˜å¯†:

ITUNES_CONNECT_USER å’Œ ITUNES_CONNECT_PASSWORD ä»¥åŠæ­¤æ–°ç”¨æˆ·çš„ App Store å‡­æ®ã€‚å¦å¤–ï¼Œå°†ç›¸åŒçš„å¯†ç è¾“å…¥ FASTLANE_PASSWORD secretã€‚

å¦‚æœæ‚¨ä½¿ç”¨ matchï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€ä¸ªåä¸º MATCH_PASSWORD çš„å¯†ç ï¼Œè¿™ä¸ªå¯†ç å°±æ˜¯æ‚¨ç”¨æ¥åŠ å¯† match repository çš„å¯†ç ã€‚

# ç»“è®º

åº”è¯¥å°±æ˜¯è¿™æ ·äº†ã€‚å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„ Pull è¯·æ±‚å¹¶åˆå¹¶å®ƒï¼Œçœ‹çœ‹ Bitrise æ˜¯å¦ä¼šè§¦å‘æ–°çš„æ„å»ºã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ‚¨å°†åœ¨ TestFlight ä¸­çœ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œå¹¶èƒ½å¤Ÿä¸ºæ‚¨çš„æ–° iOS åº”ç”¨ç¨‹åºç‰ˆæœ¬é€‰æ‹©å®ƒã€‚

![](img/7209d45b6a201c7fb19651b8bab7853a.png)

é€šè¿‡è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ‚¨å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…ï¼Œä¾‹å¦‚:

1.  ä½¿ç”¨å¿«é€Ÿé€šé“æ‰«æè¿›è¡Œæµ‹è¯•
2.  è‡ªåŠ¨åŒ–å†…éƒ¨ç‰ˆæœ¬å·é€’å¢
3.  dSYM ä¸Šä¼ åˆ° Crashlytics_Raygun_etc

ç„¶è€Œï¼Œé¦–å…ˆä»ç®€å•çš„äº‹æƒ…å¼€å§‹ã€‚å¸Œæœ›è¿™ä¸ªæŒ‡å—å¯¹ä½ æœ‰å¸®åŠ©ï¼

*å–œæ¬¢åˆ†äº«ä½ çš„æŠ€æœ¯ä¸“é•¿å—ï¼Ÿäº†è§£æ›´å¤šå…³äº* [*Bitbucket ç¼–å†™ç¨‹åº*](http://bitbucket.org/product/write) *ã€‚*

*åŸè½½äº 2019 å¹´ 4 æœˆ 29 æ—¥*[*https://bitbucket.org*](https://bitbucket.org/blog/bitbucket-bitrise-configuring-continuous-integration-for-an-ios-app)*ã€‚*