# å°† Flutter æ·»åŠ åˆ°æ‚¨çš„ç”Ÿäº§ Android åº”ç”¨ç¨‹åºä¸­

> åŸæ–‡ï¼š<https://medium.com/hackernoon/how-to-add-flutter-to-your-production-android-app-4b5150de9e44>

æœ‰å‡ ä¸ªå…³äºå¦‚ä½•å°† Flutter æ·»åŠ åˆ°æ‚¨ç°æœ‰çš„ Andriod åº”ç”¨ç¨‹åºçš„è¯´æ˜ï¼ŒåŒ…æ‹¬å®˜æ–¹ç»´åŸºï¼Œä½†æ²¡æœ‰ä¸€ä¸ªæ˜¯åœ¨çœŸæ­£çš„ç”Ÿäº§åº”ç”¨ç¨‹åºä¸Šå®Œæˆçš„ï¼Œå› æ­¤å½“æˆ‘ä»¬è¿™æ ·åšæ—¶ï¼Œæœ‰æ¯”æˆ‘ä»¬é¢„æœŸçš„æ›´å¤šçš„æŒ‘æˆ˜ï¼Œä¾‹å¦‚å­æ¨¡å—çš„ä»£ç ç»„ç»‡(ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨ä»¥åé‡ç”¨ iOS åº”ç”¨ç¨‹åº)ï¼Œå¯¹ AndroidX å’Œäº§å“é£æ ¼çš„æ”¯æŒï¼Œç±»ä¼¼äºä½¿ç”¨`intent#putExtra`å’Œ`startActivityForResult`æ¥å›ä¼ é€’æ•°æ®ï¼Œæ”¯æŒè¯¥æ¨¡å—æ‰€ä¾èµ–çš„`plugins`ï¼Œåœ¨ç¼“å­˜æ—¶æ”¯æŒä¸åŒçš„è·¯çº¿ã€‚æˆ‘ä»¬å·²ç»å°†æˆ‘ä»¬çš„ç»éªŒæå–åˆ°å¸¦æœ‰ä»£ç ç¤ºä¾‹çš„åˆ†æ­¥æŒ‡å¯¼ä¸­ã€‚

![](img/4a311ab716e1f43ee90d57b6d4366d53.png)

# 0.å‡†å¤‡æ—‹èˆå’Œä¸»æœºåº”ç”¨ç¨‹åº

æœ¬æ•™ç¨‹æ˜¯åœ¨é¢¤æŒ¯ç‰ˆæœ¬`1.5.2`ä¸Šå®Œæˆçš„ã€‚æ­¤æ—¶ï¼Œ`1.5.x`å·²ç»åœ¨`dev` [é¢‘é“](https://flutter.dev/docs/development/tools/sdk/releases)(ä¸éœ€è¦ä½¿ç”¨`master`é¢‘é“)ã€‚ç”±äº Flutter æ¯æœˆå‘å¸ƒ`beta`ï¼Œé¢„è®¡`1.5.x`å°†äºäº”æœˆåˆåœ¨`beta`ä¸Šå‘å¸ƒã€‚

æ›´æ–°:å½“ä½ è¯»åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œ`1.5.4-hotfix-2` [å·²ç»è¢«å‘½åä¸º](https://developers.googleblog.com/2019/05/Flutter-io19.html) `[stable](https://developers.googleblog.com/2019/05/Flutter-io19.html)`ã€‚

è¿™æ˜¯ä½ ç›®å‰ç”Ÿäº§çš„å®‰å“åº”ç”¨ã€‚å‡ºäºæœ¬æ–‡çš„ç›®çš„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºæ¥æ¨¡æ‹Ÿæ‚¨çš„ç”Ÿäº§åº”ç”¨ç¨‹åºï¼Œä½†å®é™…ä¸Šï¼Œå®ƒåº”è¯¥æ˜¯æ‚¨çœŸæ­£çš„åº”ç”¨ç¨‹åºã€‚

![](img/3966c177d7829e296f5feea614a9596b.png)![](img/1cf1e18bf0070b2046c06ab3613bf9be.png)

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬é€‰æ‹©â€œä½¿ç”¨ AndroidX å·¥ä»¶â€ï¼Œè¿™åæ˜ äº†æˆ‘ä»¬åœ¨è¿™æ ·åšæ—¶é‡åˆ°çš„ä¸€äº›çœŸæ­£çš„æŒ‘æˆ˜ï¼Œä½†ä½ ä¸éœ€è¦æ‹…å¿ƒï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒFlutter çš„â€œAddToAppâ€ä¸`AppCompat`é…åˆå¾—å¾ˆå¥½ã€‚

æ­¤å¤–ï¼Œä¸ºäº†ä½¿è¿™ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºæ›´æ¥è¿‘ç”Ÿäº§åº”ç”¨ç¨‹åºï¼Œè¯·ç¡®ä¿æ‚¨æœ‰æ„å»ºé£æ ¼

![](img/df8c79a1cbdaddfdf4460125beb8230e.png)![](img/6ff43412cbe2e1ee3386903765b03f7a.png)

åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/android_flutter_host/tree/step/00) ä¸Šå¯ä»¥æ‰¾åˆ°è¿™ä¸€æ­¥çš„ç¤ºä¾‹ä¸»æœºåº”ç”¨ç¨‹åºä»£ç ã€‚

# 1.åˆ›å»ºâ€œé¢¤æŒ¯æ¨¡å—â€

åœ¨æœ¬åœ°ç³»ç»Ÿçš„ä»»ä½•åœ°æ–¹(åŒ…æ‹¬ä¸»æœºåº”ç”¨ç¨‹åºå†…éƒ¨)ï¼Œè¿è¡Œå‘½ä»¤

```
flutter create -t module -i swift -a kotlin --org [your org prefix] flutter_embedding
```

*   éœ€è¦`-t module`ä»¥ä¾¿è¯¥åŒ…æ˜¯ä¸€ä¸ªé¢¤åŠ¨`module`(è€Œä¸æ˜¯ä¸`app`ã€`pakcage`æˆ–`plugin`)ã€‚
*   `-i swift`æ˜¯å¯é€‰çš„ï¼Œä½†ç›®å‰ä¼¼ä¹æ²¡æœ‰ç”Ÿæ•ˆã€‚åªæ˜¯å¯¹äºè¿™ä¸ªç‰¹å®šçš„æ¨¡å—ï¼Œä»»ä½• iOS ç›¸å…³çš„ä»£ç å°†åœ¨ Swift ä¸­(è¿™æ˜¯æˆ‘çš„åå¥½ï¼Œå¦‚æœä½ å¿½ç•¥è¿™ä¸ªé€‰é¡¹ï¼ŒiOS ç›¸å…³çš„ä»£ç ï¼Œæˆªè‡³ç›®å‰ï¼Œå°†åœ¨ Objective C ä¸­)ã€‚å¯¹äº Android å’Œ Kotlin çš„`-a kotlin`ä¹Ÿæ˜¯å¦‚æ­¤(åªé’ˆå¯¹è¿™ä¸ªç‰¹å®šçš„`module`ï¼Œä¸ä½ çš„ä¸»æœºåº”ç”¨æ˜¯ Javaã€Kotlin è¿˜æ˜¯ä¸¤è€…çš„æ··åˆæ— å…³)ã€‚
*   `--org [your org prefix]`å¯é€‰ï¼Œä½†æ¨èä½¿ç”¨ï¼Œå¦‚æœæ‚¨æœ‰ Android å’Œ/æˆ– iOS åº”ç”¨ç¨‹åºå¼€å‘èƒŒæ™¯ï¼Œåº”è¯¥ç›´æ¥ä½¿ç”¨ã€‚
*   `flutter_embedded`æ˜¯å¿…éœ€çš„ï¼Œå®ƒæ˜¯åŒ…åä¸­`[your org prefix]`ä¹‹åçš„åå­—ï¼Œä¹Ÿæ˜¯è¿™ä¸ªæ¨¡æ¿ä»£ç ä¸Šç”Ÿæˆçš„æ–‡ä»¶å¤¹ã€‚

åœ¨ git repo ä¸Šæäº¤å’Œæ¨é€ä»£ç (æ¯”å¦‚æ‚¨å…¬å¸çš„ç§æœ‰è‡ªæ‰˜ç®¡ git repoï¼Œæˆ– Github)ï¼Œå¹¶è®°ä½è¦åœ¨ä¸‹é¢çš„æ­¥éª¤ä¸­ä½¿ç”¨çš„ git URLã€‚å°½ç®¡ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä½ çš„ä¸»æœºåº”ç”¨ç¨‹åºä»£ç ä¸‹æäº¤è¿™ä¸ªç›®å½•ï¼Œä½†å»ºè®®æŠŠå®ƒä½œä¸ºä¸€ä¸ª`git submodule`æ¥æäº¤ï¼Œè¿™æ ·æˆ‘ä»¬ä»¥åä¹Ÿå¯ä»¥å’Œä¸€ä¸ª iOS åº”ç”¨ç¨‹åºå…±äº«è¿™ä¸ª flutter æ¨¡å—ã€‚

ç„¶åï¼Œä¸ºäº†æ”¯æŒ`AndroidX`ï¼Œæ‚¨éœ€è¦åšå‡ºå¦‚ä¸‹å˜é€š:å°†å¤§å¤šæ•°æ–‡ä»¶åŒ…å«åœ¨ç›®å½•`.android`ä¸‹ï¼Œå¹¶å°† Java æ–‡ä»¶è¿ç§»åˆ° AndroidX

è¿™ä¸€æ­¥åµŒå…¥æ¨¡å—ä»£ç åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/flutter_embedding/tree/step/01) ä¸Šæœ‰ã€‚

# 2.è®©è¿™ä¸ªâ€œé¢¤åŠ¨æ¨¡å—â€æˆä¸ºä½ çš„ä¸»æœºåº”ç”¨ç¨‹åºçš„ä¸€ä¸ªâ€œgit å­æ¨¡å—â€

åœ¨æ‚¨çš„ä¸»æœºåº”ç”¨ç¨‹åºä¸­ï¼Œè¿è¡Œå‘½ä»¤å°†`flutter module`æ·»åŠ ä¸º`git submodule`:

```
git submodule add [your git URL of flutter embedding module in step 1] flutter_embedding
```

`flutter_embedding`æ˜¯è¿™ä¸ªå­æ¨¡å—çš„ç›®å½•åçš„æ¨èåç§°ï¼Œä»¥é¿å…ä¸`flutter`æœ¬èº«çš„åç§°ç©ºé—´å†²çªï¼ŒåŒæ—¶ä¹Ÿè¶³å¤Ÿç®€å•æ˜äº†ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ­¤æ—¶æ‚¨æ­£åœ¨ä½¿ç”¨ iOSï¼Œæ‚¨å°†ä¸å¾—ä¸éƒ¨åˆ†é‡æ–°ç”Ÿæˆæ¨¡å—ï¼Œå› ä¸º`.ios`ç›®å½•è¢«å¿½ç•¥ã€‚

å¦‚æœä½ åœ¨`flutter_embedded`ä¸‹æ£€æŸ¥ä½ çš„ç›®å½•ï¼Œä½ ä¼šçœ‹åˆ°ä¸€äº›æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨`git diff`ä¸‹ï¼Œä½ åªä¼šçœ‹åˆ°å­æ¨¡å—çš„ git URLï¼Œä»¥åŠè¿™ä¸ªå­æ¨¡å—æŒ‡å‘çš„å½“å‰ hash commitã€‚

ä¸»æœº app è¿™ä¸€æ­¥çš„ä»£ç åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/android_flutter_host/tree/step/02) ä¸Šæœ‰ã€‚

# 3.ä»æœ¬æœºåº”ç”¨ç¨‹åºæ´»åŠ¨è°ƒç”¨ FlutterEmbeddingActivity

ä¸ºäº†èƒ½å¤Ÿä»æœ¬åœ°åº”ç”¨æ´»åŠ¨ä¸­è°ƒç”¨`FlutterEmbeddingActivity`ï¼Œæ‚¨éœ€è¦å‘ä¸»æœºåº”ç”¨æ¢¯åº¦è„šæœ¬æ³¨å†Œ`flutter module`

åœ¨å­˜å‚¨æ‰€æœ‰æ´»åŠ¨çš„ç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ´»åŠ¨`FlutterEmbeddingActivity`ã€‚

è¿™ä¸ªæ´»åŠ¨æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•`init`æ¥åˆå§‹åŒ–å’Œåˆ›å»ºä¸€ä¸ªç¼“å­˜çš„ flutter å¼•æ“ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå¹¶åœ¨ä»¥åç”¨äº`flutter plugin`æ³¨å†Œã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ´»åŠ¨å¿…é¡»æ‰©å±•`io.flutter.embedding.android.FlutterActivity`ï¼Œè€Œä¸æ˜¯`io.flutter.app.FlutterActivity`ï¼Œå¦åˆ™ï¼Œæˆ‘ä»¬æ— æ³•è¦†ç›–`IntentBuilder`ã€‚å½“æˆ‘ä»¬æ³¨å†Œ`flutter plugin`æ—¶ï¼Œè¯¥æ³¨é‡Šå¯¹äºåé¢çš„æ­¥éª¤ä¹Ÿå¾ˆé‡è¦ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ–°çš„æ´»åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ AndroidManifest.xml ä¸­æ³¨å†Œå®ƒï¼Œå¹¶ä»å…¶ä»–æ´»åŠ¨ä¸­è°ƒç”¨å®ƒ

æ˜¯å¦/åœ¨å“ªé‡Œè°ƒç”¨`FlutterEmbeddingActivity.init(this)`ï¼Œæ˜¯ä¸€ä¸ªæƒè¡¡çš„å†³å®šã€‚ä½ æœ‰ä¸‰ä¸ªé€‰æ‹©

*   åœ¨ä½ è¿›å…¥æ´»åŠ¨çš„`onCreate`ä¸­è°ƒç”¨å®ƒã€‚ä¼˜ç‚¹:ä»æœ¬æœºæ´»åŠ¨è¿‡æ¸¡åˆ° Flutter åµŒå…¥æ´»åŠ¨æ—¶æ€§èƒ½æ›´å¥½(ç¬¬ä¸€æ¬¡)ï¼Œç¼ºç‚¹:åº”ç”¨å¯åŠ¨æ—¶æ€§èƒ½æ›´å·®ã€‚
*   åœ¨`onCreate`ä¸­è°ƒç”¨å®ƒçš„æ´»åŠ¨ä¼šç«‹å³å¯¼è‡´åµŒå…¥æ´»åŠ¨çš„é¢¤åŠ¨ã€‚ä¼˜ç‚¹:ä»æœ¬æœºæ´»åŠ¨è½¬æ¢åˆ° Flutter åµŒå…¥æ´»åŠ¨æ—¶æ€§èƒ½æ›´å¥½(ç¬¬ä¸€æ¬¡)ï¼Œç¼ºç‚¹:ä»ä¸€ä¸ªæœ¬æœºåº”ç”¨ç¨‹åºæ´»åŠ¨è½¬æ¢åˆ°å¦ä¸€ä¸ªè°ƒç”¨`init`çš„æœ¬æœºåº”ç”¨ç¨‹åºæ´»åŠ¨æ—¶æ€§èƒ½æ›´å·®(ç¬¬ä¸€æ¬¡)ã€‚
*   æ ¹æœ¬ä¸è¦è°ƒç”¨`FlutterEmbeddingActivity.init(this)`ã€‚ä¼˜ç‚¹:åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶æˆ–åœ¨æœ¬åœ°åº”ç”¨ç¨‹åºæ´»åŠ¨ä¸­æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œç¼ºç‚¹:ä»æœ¬åœ°æ´»åŠ¨è¿‡æ¸¡åˆ° Flutter åµŒå…¥æ´»åŠ¨æ—¶æ€§èƒ½æ›´å·®(ç¬¬ä¸€æ¬¡)

ä½†æ˜¯ï¼Œæ‚¨ä¸èƒ½åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨`FlutterEmbeddingActivity.init(this)`,å› ä¸ºå®ƒä¼šå´©æºƒ

```
java.lang.IllegalStateException: startInitialization must be called on the main thread
```

å¦‚æœæ‚¨ç°åœ¨å¼€å§‹è°ƒè¯•ï¼Œæ‚¨å°†çœ‹åˆ°åº”ç”¨ç¨‹åºåœ¨å¯åŠ¨åç«‹å³å´©æºƒï¼Œå¹¶æ˜¾ç¤ºä»¥ä¸‹æ—¥å¿—

```
E/flutter: [ERROR:flutter/runtime/dart_vm_data.cc(19)] VM snapshot invalid and could not be inferred from settings.
    [ERROR:flutter/runtime/dart_vm.cc(237)] Could not setup VM data to bootstrap the VM from.
    [ERROR:flutter/runtime/dart_vm_lifecycle.cc(81)] Could not create Dart VM instance.
A/flutter: [FATAL:flutter/shell/common/shell.cc(218)] Check failed: vm. Must be able to initialize the VM.
A/libc: Fatal signal 6 (SIGABRT), code -6 in tid 12928 (utter_host.free)
```

è¿™æ˜¯ä¸€ä¸ª[å·²çŸ¥é”™è¯¯](https://github.com/flutter/flutter/issues/30916)ï¼Œè§£å†³æ–¹æ³•æ˜¯åœ¨`app/build.gradle`ä¸­æ·»åŠ ä»¥ä¸‹å‡ è¡Œ

ä¸Šè¿°è§£å†³æ–¹æ³•å°†ä¿®å¤æ‰€æœ‰äº§å“é£æ ¼å’Œæ„å»ºç±»å‹(å¦‚`Debug`ã€`Profile`ã€`Release`)çš„é—®é¢˜ã€‚ç°åœ¨å†æ¬¡å¼€å§‹è°ƒè¯•ä½ çš„åº”ç”¨ç¨‹åºï¼Œç‚¹å‡» fab æŒ‰é’®ï¼Œä½ åº”è¯¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°è¿™äº›è¡Œ(è¡¨æ˜æˆ‘ä»¬ç¡®å®åœ¨ä½¿ç”¨ç¼“å­˜çš„ Flutter å¼•æ“)

```
D/FlutterFragment: Deferring to attached Activity to provide a FlutterEngine.
D/FlutterView: Initializing FlutterView
    Internally creating a FlutterSurfaceView.
```

åº”ç”¨ç¬¬ä¸€æ¬¡ä»åŸç”Ÿæ´»åŠ¨è¿‡æ¸¡åˆ° Flutter åµŒå…¥æ´»åŠ¨æ—¶ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªå°çš„æ»åï¼Œä½†åç»­çš„è¿‡æ¸¡è¦å¹³æ»‘å¾—å¤šã€‚

![](img/d5c455f14014a9cc66ff11837dc885be.png)![](img/327bf2a6372b5175f7e8165a6cc7f598.png)

æ­¤å¤–ï¼ŒFlutter åµŒå…¥æ´»åŠ¨çš„å†…éƒ¨çŠ¶æ€æ˜¯æŒä¹…çš„ï¼Œè¿™æ„å‘³ç€æ‚¨ç‚¹å‡»â€œåé€€æŒ‰é’®â€ä»¥è¿”å›åˆ°æœ¬æœºåº”ç”¨ç¨‹åºæ´»åŠ¨ï¼Œç„¶åç‚¹å‡» FabButtonï¼Œæ‚¨å°†çœ‹åˆ°è®¡æ•°å™¨ç¼–å·ä¿æŒä¸å˜(å¹¶ä¸”ä¸ä¼šé‡ç½®ä¸º 0)ã€‚

æ­¤æ—¶ï¼Œæ‚¨è¿˜å¯ä»¥å°† Android Studio é™„åŠ åˆ° Flutter æ´»åŠ¨ï¼Œä»¥è°ƒè¯•æ‚¨çš„ Dart ä»£ç ï¼Œè¿›è¡Œçƒ­é‡è£…å’Œçƒ­é‡å¯ã€‚

ä¸»æœº app è¿™ä¸€æ­¥çš„ä»£ç åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/android_flutter_host/tree/step/03) ä¸Šæœ‰ã€‚

# 4.æ‰“å¼€ä¸åŒçš„é¢¤åŠ¨å±å¹•

å½“æ‚¨çš„åº”ç”¨ç¨‹åºåœ¨ Flutter ç«¯å¢é•¿æ—¶ï¼Œæ‚¨å°†éœ€è¦åµŒå…¥æ´»åŠ¨æ¥æ˜¾ç¤ºå¤šä¸ªå±å¹•/è·¯å¾„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†æœ‰â€œcounterâ€å±å¹•å’Œå¦ä¸€ä¸ªâ€œhello worldâ€å±å¹•ã€‚

æ ¹æ®ç›®å‰çš„å®˜æ–¹ç»´åŸºï¼Œä½ å¯ä»¥ç”¨`createBuilder().initialRoute`å’Œ`createBuilder().dartEntrypoint`ä¸­çš„ä¸€ä¸ª/ä¸¤ä¸ªæ¥å®ç°è¿™ä¸ªã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å‘ç°ï¼Œä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨ç¼“å­˜çš„é¢¤æŒ¯å¼•æ“ï¼Œè¿™äº›æ–¹æ³•ä¸å†å·¥ä½œã€‚æˆ‘ä»¬ç°åœ¨è¦åšçš„å°±æ˜¯æŠŠæœ€é¡¶å±‚çš„å°éƒ¨ä»¶(`MyApp`)è½¬æ¢æˆæœ‰çŠ¶æ€çš„å°éƒ¨ä»¶ï¼Œç›‘å¬å¹³å°é€šé“(äº‹ä»¶é€šé“)å¹¶æ®æ­¤æ„å»ºå°éƒ¨ä»¶ã€‚

åœ¨`flutter_embedding/lib/main.dart`ä¸­ï¼Œå°†æœ€é¡¶å±‚çš„å°éƒ¨ä»¶è½¬æ¢æˆæœ‰çŠ¶æ€çš„å°éƒ¨ä»¶ï¼Œç›‘å¬äº‹ä»¶é€šé“å¹¶ç›¸åº”åœ°è®¾ç½®çŠ¶æ€ã€‚æ³¨æ„ï¼Œåœ¨ç¬¬ 32 è¡Œï¼Œæˆ‘ä»¬è¿˜ç¡®å®šè·¯çº¿æ˜¯å¦æ˜¯`init`ï¼Œæˆ‘ä»¬å°†ç«‹å³è¿”å›åˆ°åŸç”Ÿ Android æ´»åŠ¨ã€‚è¿™æ ·åšåªæ˜¯ä¸ºäº†ç¼“å­˜ã€‚

åœ¨`FlutterEmbeddingActivity`ä¸­ï¼Œæ¯å½“è¿™ä¸ªæ´»åŠ¨æ˜¯`onCreate`æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å¹³å°é€šé“å‘ Dart æ–¹å‘é€æ¶ˆæ¯ã€‚

åŒæ ·å‡ºäºç¼“å­˜çš„ç›®çš„ï¼Œå¦‚æœä¸æ˜¯ä»`FlutterEmbeddingActivity`è°ƒç”¨`init`ï¼Œæˆ‘ä»¬å°†å‘ˆç° Flutter è§†å›¾(æ— è®ºå¦‚ä½•éƒ½ä¼šä» Dart ç«¯ç«‹å³`pop`è°ƒç”¨)

æœ€åï¼Œåœ¨ä»»ä½•å…¶ä»–æ´»åŠ¨ä¸­ï¼Œç”¨`initialRoute`åˆ›å»ºä¸€ä¸ªé¢¤æŒ¯`Intent`ï¼Œå¹¶å¼€å§‹è¯¥æ´»åŠ¨ã€‚

ä½ ä¼šçœ‹åˆ°ï¼Œç‚¹å‡»ä¸åŒçš„æŒ‰é’®ä¼šå¯¼è‡´ä½ ä¸åŒçš„é¢¤æŒ¯å±å¹•ã€‚æ­¤å¤–ï¼Œâ€œè®¡æ•°å™¨â€çš„çŠ¶æ€å°†è¢«ä¿ç•™ï¼Œå¦‚æœä½ åªæ˜¯æ¥å›åˆ°é‚£ä¸ªé¢¤åŠ¨çš„å±å¹•ï¼Œä½†è¢«é‡ç½®(åˆ° 0)ï¼Œå¦‚æœä½ è®¿é—®å¦ä¸€ä¸ªå±å¹•ï¼Œå¹¶å›åˆ°â€œè®¡æ•°å™¨â€å±å¹•ã€‚

è¿™ä¸€æ­¥çš„ä»£ç å¯ä»¥åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/android_flutter_host/tree/android_step/04) ä¸Šæ‰¾åˆ°ã€‚

# 5.æ„å›¾å’Œè¿”å›æ„å›¾é™„åŠ å†…å®¹

æœ‰ Android å¼€å‘èƒŒæ™¯ï¼Œæ¯«æ— ç–‘é—®ï¼Œä½ è‡³å°‘æ›¾ç»ä½¿ç”¨è¿‡`intent#putExtra`å‘ä¸‹ä¸€ä¸ªæ´»åŠ¨ä¼ é€’æ•°æ®ï¼Œä½¿ç”¨`startActivityForResult`å’Œ`returnIntent#putExtra`å‘ä¸Šä¸€ä¸ªæ´»åŠ¨ä¼ é€’æ•°æ®ã€‚å€ŸåŠ©äºå¹³å°é€šé“(è¿™æ¬¡æ˜¯äº‹ä»¶é€šé“å’Œæ–¹æ³•é€šé“)ï¼Œä¹Ÿå¯ä»¥ç”¨ Flutter activity/screen æ¥å®ç°ã€‚åœ¨è¿™æ ·åšçš„æ—¶å€™ï¼Œä½ åº”è¯¥çŸ¥é“ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„æœ‰èµ„æ ¼é€šè¿‡ Dart å’Œ Android ä¹‹é—´çš„æ¡¥æ¢ã€‚

åœ¨ Dart ç«¯ï¼Œæˆ‘ä»¬ä»åŒä¸€ä¸ªäº‹ä»¶ä¸­è·å¾—é¢å¤–çš„æ•°æ®

åœ¨`FlutterEmbeddingActivity.kt`ä¸­ï¼Œæˆ‘ä»¬å°†ä» Dart ç«¯æ¥æ”¶çš„æ•°æ®è½¬æ¢ä¸º`Intent`çš„é¢å¤–æ•°æ®ï¼Œå¹¶ä½¿ç”¨`setResult`å’Œ`finish`å°†æ•°æ®ä¼ é€’å›ä¹‹å‰çš„æ´»åŠ¨

åœ¨è°ƒç”¨æ´»åŠ¨ä¸­ï¼Œæˆ‘ä»¬ç”¨`startActivityForResult`æ›¿æ¢`startActivity`ï¼Œç”¨`onActivityResult`å¬ç»“æœ

ä¸»æœº app è¿™ä¸€æ­¥çš„ä»£ç åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/android_flutter_host/tree/android_step/05) ä¸Šæœ‰ã€‚

# 6.ä½¿ç”¨é¢¤æŒ¯æ’ä»¶

å‘å±•æ‚¨çš„ç”Ÿäº§åº”ç”¨ç¨‹åºï¼Œæ¯«æ— ç–‘é—®ï¼Œåœ¨æŸäº›æ—¶å€™ï¼Œæ‚¨å°†éœ€è¦æ‚¨çš„ Flutter æ´»åŠ¨æ¥è®¿é—®å¹³å°çš„ç‰¹å®šæ•°æ®ï¼Œå¦‚ç›¸æœºã€éŸ³é¢‘æˆ–ä¼ æ„Ÿå™¨ã€‚ä½ å¯ä»¥è‡ªå·±å®ç°æ‰€æœ‰çš„å¹³å°é€šé“æ¥å¤„ç†è¿™äº›æ•°æ®ï¼Œæˆ–è€…ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ https://pub.dartlang.org/flutter ä¸Šå¯ç”¨çš„ Flutter æ’ä»¶ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨é€‰æ‹©åä¸€ç§æ–¹æ³•ï¼Œè¿™æ ·ä»¥åå½“ Flutter activity è¶…è¿‡æœ¬æœºåº”ç”¨ç¨‹åºå¹¶æˆä¸ºåº”ç”¨ç¨‹åºæœ¬èº«æ—¶ï¼Œæ‚¨å°±ä¸éœ€è¦ç»´æŠ¤ Kotlin/Java ä»£ç åº“äº†ã€‚

è®©æˆ‘ä»¬ä»¥ [path_provider](https://pub.dartlang.org/packages/path_provider) åŒ…ä¸ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦`getApplicationDocumentsDirectory`ï¼Œå¹¶ä½¿ç”¨å‰é¢æ­¥éª¤ä¸­å®ç°çš„`ReturnIntent extras`å°†æ•°æ®ä¼ å›ã€‚æˆ‘ä»¬åœ¨`pubspec.yml`ä¸­å®šä¹‰ä¾èµ–å…³ç³»ï¼Œå¹¶è°ƒç”¨æ–¹æ³•è·å–æ•°æ®(å­—ç¬¦ä¸²æ ¼å¼)

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ç°åœ¨è¿è¡Œå¹¶æµ‹è¯•è¯¥åº”ç”¨ç¨‹åºï¼Œæ‚¨å°†ä¼šå¾—åˆ°ä»¥ä¸‹é”™è¯¯

```
E/flutter: [ERROR:flutter/lib/ui/ui_dart_state.cc(148)] Unhandled Exception: MissingPluginException(No implementation found for method getApplicationDocumentsDirectory on channel plugins.flutter.io/path_provider)
```

æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨ Android è¿™è¾¹æ³¨å†Œ`path_provider`æ’ä»¶çš„å¹³å°é€šé“ã€‚è¿™æ ·åšï¼Œé€šå¸¸åœ¨æ´»åŠ¨çš„`onCreate`æˆ‘ä»¬ç§°ä¹‹ä¸º`GeneratedPluginRegistrant.registerWith(this)`ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ç—›è‹¦åœ°å‘ç°ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨å½“å‰çš„`FlutterEmbeddingActivity`ä¸­ä½¿ç”¨è¯¥ç­–ç•¥ã€‚åŸå› æ˜¯æˆ‘ä»¬çš„æ´»åŠ¨ä»`io.flutter.embedding.android.FlutterActivity`å»¶ä¼¸ï¼Œè€Œä¸æ˜¯`io.flutter.app.FlutterActivity`ã€‚è¿›ä¸€æ­¥ç ”ç©¶`GeneratedPluginRegistrant`ï¼Œçœ‹èµ·æ¥è¿™æ®µä»£ç åªéœ€è¦ 2 æ ·ä¸œè¥¿ï¼Œå¯¹å½“å‰æ´»åŠ¨çš„å¼•ç”¨ï¼Œä»¥åŠ`messenger`ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯`cachedFlutterEngine.dartExecutor`ã€‚äº†è§£åˆ°è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼Œå°½ç®¡æœ‰ç‚¹å†—é•¿ã€‚

è¿™ä¸€æ¬¡ï¼Œæµ‹è¯•ä½ çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„å·¥ä½œé¢„æœŸ

```
D/Flutter example: requestCode: 42, resultCode: 24, data {returnArg1=/data/user/0/pro.truongsinh.flutter.android_flutter_host.free/app_flutter, returnArg2=2}
```

ä¸»æœº app è¿™ä¸€æ­¥çš„ä»£ç åœ¨æˆ‘çš„ [Github](https://github.com/truongsinh/android_flutter_host/tree/android_step/06) ä¸Šæœ‰ã€‚

# ç»“è®º

å°½ç®¡ Flutter çš„ [Add2App](https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps) è¿˜å¤„äºé¢„è§ˆé˜¶æ®µï¼Œä½†å®ƒå·²ç»å¯ä»¥ç”¨åœ¨ç”Ÿäº§åº”ç”¨ä¸Šäº†ï¼Œåªéœ€ç¨å¾®è°ƒæ•´ä¸€ä¸‹å°±å¯ä»¥æ”¯æŒä¸€äº›å¸¸è§çš„ç”¨ä¾‹ï¼Œæ¯”å¦‚

*   å®‰å“å…‹æ–¯
*   äº§å“é£å‘³
*   ä½¿ç”¨ç¼“å­˜é¢¤æŒ¯å¼•æ“æ—¶çš„ä¸åŒè·¯çº¿
*   åƒä½¿ç”¨`intent#putExtra`å’Œ`startActivityForResult`ä¸€æ ·æ¥å›ä¼ é€’æ•°æ®
*   è¯¥æ¨¡å—æ‰€ä¾èµ–çš„é¢¤æŒ¯çš„`plugins`

æœ¬æ–‡ä¸­çš„`FlutterEmbeddingActivity`ä»£ç æ ·æœ¬çš„è®¾è®¡ä½¿å¾—å®ƒçš„ä¸€äº›ä»£ç æœ€ç»ˆä¼šå‡ºç°åœ¨ Flutter å¼•æ“çš„ä»£ç ä¸­ï¼Œä»è€Œå‡å°‘äº†æ ·æ¿ä»£ç ã€‚åŒæ—¶ï¼Œå¦‚æœä½ æƒ³å…¥é—¨ Flutter å’Œä½ çš„åˆ¶ä½œ appï¼Œå»ºè®®å°† Flutter åµŒå…¥åˆ°ä½ å½“å‰çš„ app ä¸­ï¼Œè€Œä¸æ˜¯é‡æ–°æ„å»ºæ•´ä¸ª Flutter appï¼Œå‡å°‘é£é™©å’Œåé¦ˆå›è·¯ã€‚

è¿™ç¯‡æ–‡ç« æ˜¯å…è´¹çš„ï¼Œä½ çš„æ‹æ‰‹ä¹Ÿæ˜¯å…è´¹çš„ğŸ‘ã€‚ä½ çŸ¥é“ä½ å¯ä»¥æŒ‰æ‹æ‰‹é”®å—ğŸ‘æŒ‰é’® 50 æ¬¡ï¼Ÿ