<html>
<head>
<title>Avoiding Race Conditions when Fetching Data with React Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨ReactæŒ‚é’©æå–æ•°æ®æ—¶é¿å…ç«äº‰æƒ…å†µ</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/hackernoon/avoiding-race-conditions-when-fetching-data-with-react-hooks-220d6fd0f663?source=collection_archive---------0-----------------------#2019-04-15">https://medium.com/hackernoon/avoiding-race-conditions-when-fetching-data-with-react-hooks-220d6fd0f663?source=collection_archive---------0-----------------------#2019-04-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/61ee01831bad85ad4644517bd3a6b418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*okLGlm1oBbTkR9OIm--MYA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Man jumping over clock</figcaption></figure><p id="c572" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">å¤§çº¦ä¸€ä¸ªæœˆå‰ï¼Œæˆ‘åœ¨Twitterä¸Šå‘å¸ƒäº†ä¸€ä¸ªä½¿ç”¨React Hooksè·å–æ•°æ®çš„ä¾‹å­ã€‚è™½ç„¶æœ¬æ„æ˜¯å¥½çš„ï¼Œä½†æ˜¯Dan abro mov(Reactæ ¸å¿ƒå›¢é˜Ÿçš„)è®©æˆ‘çŸ¥é“æˆ‘çš„å®ç°åŒ…å«äº†ä¸€ä¸ªç«äº‰æ¡ä»¶ã€‚å› æ­¤ï¼Œæˆ‘ç­”åº”å†™ä¸€ç¯‡åšæ–‡æ¥çº æ­£æˆ‘çš„å®ç°ã€‚è¿™å°±æ˜¯é‚£ä¸ªå¸–å­ï¼</p><p id="b5e6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">æ³¨:</strong>å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·å€Ÿä¸€ä¸ªæ‹æ‰‹(æˆ–50)å¸®å¿™ä¼ æ’­ä¸€ä¸‹ï¼ğŸ‘ğŸ‘</p><p id="7597" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt">***</p><h2 id="5b33" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">é€šè¿‡æ³¨å†Œæˆ‘çš„å…è´¹æ—¶äº‹é€šè®¯ï¼Œåœ¨æ‚¨çš„æ”¶ä»¶ç®±ä¸­è·å¾—å¿«é€ŸJavaScriptæŠ€å·§ï¼</h2><figure class="kz la lb lc fq iv"><div class="bz el l di"><div class="ld le l"/></div></figure><p id="8355" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt">***</p><h1 id="a10c" class="lf kf hu bd kg lg lh li kk lj lk ll ko lm ln lo kr lp lq lr ku ls lt lu kx lv dt translated">è®¾ç½®</h1><p id="672e" class="pw-post-body-paragraph jg jh hu ji b jj lw jl jm jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd hn dt translated">åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºä¸­ï¼Œå½“äººä»¬çš„åå­—è¢«ç‚¹å‡»æ—¶ï¼Œæˆ‘ä»¬å°†è™šå‡åŠ è½½ä»–ä»¬çš„ä¸ªäººèµ„æ–™æ•°æ®ã€‚ä¸ºäº†å¸®åŠ©å¯è§†åŒ–ç«äº‰æ¡ä»¶ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª<code class="eh mb mc md me b">fakeFetch</code>å‡½æ•°ï¼Œå®ç°0åˆ°5ç§’ä¹‹é—´çš„éšæœºå»¶è¿Ÿã€‚</p><pre class="kz la lb lc fq mf me mg mh aw mi dt"><span id="170c" class="ke kf hu me b fv mj mk l ml mm">const fakeFetch = person =&gt; {<br/>  return new Promise(res =&gt; {<br/>    setTimeout(() =&gt; res(`${person}'s data`), Math.random() * 5000);<br/>  });<br/>};</span></pre><h1 id="aff9" class="lf kf hu bd kg lg lh li kk lj lk ll ko lm ln lo kr lp lq lr ku ls lt lu kx lv dt translated">åˆå§‹å®æ–½</h1><p id="9728" class="pw-post-body-paragraph jg jh hu ji b jj lw jl jm jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd hn dt translated">æˆ‘ä»¬æœ€åˆçš„å®ç°å°†ä½¿ç”¨æŒ‰é’®æ¥è®¾ç½®å½“å‰é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬ä½¿ç”¨<code class="eh mb mc md me b">useState</code>é’©å­æ¥å®ç°å®ƒï¼Œç»´æŠ¤ä»¥ä¸‹çŠ¶æ€:</p><ul class=""><li id="a754" class="mn mo hu ji b jj jk jn jo jr mp jv mq jz mr kd ms mt mu mv dt translated"><code class="eh mb mc md me b">person</code>ï¼Œç”¨æˆ·é€‰æ‹©çš„äºº</li><li id="706a" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated"><code class="eh mb mc md me b">data</code>ï¼Œæ ¹æ®æ‰€é€‰äººå‘˜ä»æˆ‘ä»¬çš„å‡è·å–ä¸­åŠ è½½çš„æ•°æ®</li><li id="d09d" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated"><code class="eh mb mc md me b">loading</code>ï¼Œå½“å‰æ˜¯å¦æ­£åœ¨åŠ è½½æ•°æ®</li></ul><p id="c11d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">æˆ‘ä»¬é¢å¤–ä½¿ç”¨äº†<code class="eh mb mc md me b">useEffect</code>é’©å­ï¼Œæ¯å½“<code class="eh mb mc md me b">person</code>æ”¹å˜æ—¶ï¼Œå®ƒæ‰§è¡Œæˆ‘ä»¬çš„å‡è·å–ã€‚</p><pre class="kz la lb lc fq mf me mg mh aw mi dt"><span id="4948" class="ke kf hu me b fv mj mk l ml mm">import React, { Fragment, useState, useEffect } from 'react';</span><span id="8aca" class="ke kf hu me b fv nb mk l ml mm">const fakeFetch = person =&gt; {<br/>  return new Promise(res =&gt; {<br/>    setTimeout(() =&gt; res(`${person}'s data`), Math.random() * 5000);<br/>  });<br/>};</span><span id="018c" class="ke kf hu me b fv nb mk l ml mm">const App = () =&gt; {<br/>  const [data, setData] = useState('');<br/>  const [loading, setLoading] = useState(false);<br/>  const [person, setPerson] = useState(null);</span><span id="059f" class="ke kf hu me b fv nb mk l ml mm">  useEffect(() =&gt; {<br/>    setLoading(true);<br/>    fakeFetch(person).then(data =&gt; {<br/>      setData(data);<br/>      setLoading(false);<br/>    });<br/>  }, [person]);</span><span id="3a4e" class="ke kf hu me b fv nb mk l ml mm">  return (<br/>    &lt;Fragment&gt;<br/>      &lt;button onClick={() =&gt; setPerson('Nick')}&gt;Nick's Profile&lt;/button&gt;<br/>      &lt;button onClick={() =&gt; setPerson('Deb')}&gt;Deb's Profile&lt;/button&gt;<br/>      &lt;button onClick={() =&gt; setPerson('Joe')}&gt;Joe's Profile&lt;/button&gt;<br/>      {person &amp;&amp; (<br/>        &lt;Fragment&gt;<br/>          &lt;h1&gt;{person}&lt;/h1&gt;<br/>          &lt;p&gt;{loading ? 'Loading...' : data}&lt;/p&gt;<br/>        &lt;/Fragment&gt;<br/>      )}<br/>    &lt;/Fragment&gt;<br/>  );<br/>};<br/>export default App;</span></pre><p id="4e73" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">å¦‚æœæˆ‘ä»¬è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¹¶å•å‡»å…¶ä¸­ä¸€ä¸ªæŒ‰é’®ï¼Œæˆ‘ä»¬çš„ä¼ªfetchå°†æŒ‰é¢„æœŸåŠ è½½æ•°æ®ã€‚</p><h1 id="3103" class="lf kf hu bd kg lg lh li kk lj lk ll ko lm ln lo kr lp lq lr ku ls lt lu kx lv dt translated">è¾¾åˆ°æ¯”èµ›æ¡ä»¶</h1><p id="5493" class="pw-post-body-paragraph jg jh hu ji b jj lw jl jm jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd hn dt translated">å½“æˆ‘ä»¬å¼€å§‹åœ¨äººä¸äººä¹‹é—´å¿«é€Ÿè½¬æ¢æ—¶ï¼Œéº»çƒ¦å°±æ¥äº†ã€‚å‡è®¾æˆ‘ä»¬çš„å‡æå–æœ‰ä¸€ä¸ªéšæœºå»¶è¿Ÿï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šå‘ç°æˆ‘ä»¬çš„æå–ç»“æœå¯èƒ½ä¼šä¹±åºè¿”å›ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é€‰æ‹©çš„é…ç½®æ–‡ä»¶å’ŒåŠ è½½çš„æ•°æ®å¯èƒ½ä¸åŒæ­¥ã€‚é‚£æ˜¯ä¸€å‰¯ç³Ÿç³•çš„è¡¨æƒ…ï¼</p><figure class="kz la lb lc fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nc"><img src="../Images/5836691ae8548a1a9edd247044330bd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/0*odL0POtVf8EHjqQi.gif"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Clicking buttons quickly and hitting the race condition</figcaption></figure><p id="3a99" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…ç›¸å¯¹ç›´è§‚:<code class="eh mb mc md me b">useEffect</code>é’©å­å†…çš„<code class="eh mb mc md me b">setData(data)</code>åªæœ‰åœ¨<code class="eh mb mc md me b">fakeFetch</code>æ‰¿è¯ºè¢«è§£æåæ‰è¢«è°ƒç”¨ã€‚æ— è®ºå“ªä¸ªæ‰¿è¯ºæœ€åè§£å†³ï¼Œéƒ½å°†æœ€åè°ƒç”¨<code class="eh mb mc md me b">setData</code>ï¼Œè€Œä¸ç®¡å“ªä¸ªæŒ‰é’®å®é™…ä¸Šæ˜¯æœ€åè°ƒç”¨çš„ã€‚</p><h1 id="4361" class="lf kf hu bd kg lg lh li kk lj lk ll ko lm ln lo kr lp lq lr ku ls lt lu kx lv dt translated">å–æ¶ˆä»¥å‰çš„æå–</h1><p id="1518" class="pw-post-body-paragraph jg jh hu ji b jj lw jl jm jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd hn dt translated">æˆ‘ä»¬å¯ä»¥é€šè¿‡â€œå–æ¶ˆâ€ä»»ä½•éæœ€æ–°ç‚¹å‡»çš„<code class="eh mb mc md me b">setData</code>è°ƒç”¨æ¥ä¿®å¤è¿™ç§ç«äº‰æƒ…å†µã€‚æˆ‘ä»¬é€šè¿‡åœ¨<code class="eh mb mc md me b">useEffect</code>é’©å­å†…åˆ›å»ºä¸€ä¸ªå¸ƒå°”å˜é‡ï¼Œå¹¶ä»<code class="eh mb mc md me b">useEffect</code>é’©å­è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œå°†è¿™ä¸ªå¸ƒå°”â€œå–æ¶ˆâ€å˜é‡è®¾ç½®ä¸º<code class="eh mb mc md me b">true</code>æ¥å®ç°ã€‚å½“æ‰¿è¯ºè§£ææ—¶ï¼Œåªæœ‰å½“â€œå–æ¶ˆâ€å˜é‡ä¸ºå‡æ—¶ï¼Œ<code class="eh mb mc md me b">setData</code>æ‰ä¼šè¢«è°ƒç”¨ã€‚</p><p id="b42c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">å¦‚æœè¿™ä¸ªæè¿°æœ‰ç‚¹æ··ä¹±ï¼Œä¸‹é¢çš„ä»£ç ç¤ºä¾‹åº”è¯¥ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p><pre class="kz la lb lc fq mf me mg mh aw mi dt"><span id="6b5b" class="ke kf hu me b fv mj mk l ml mm">useEffect(() =&gt; {<br/>  let canceled = false;</span><span id="4f65" class="ke kf hu me b fv nb mk l ml mm">  setLoading(true);<br/>  fakeFetch(person).then(data =&gt; {<br/>    if (!canceled) {<br/>      setData(data);<br/>      setLoading(false);<br/>    }<br/>  });</span><span id="6a4e" class="ke kf hu me b fv nb mk l ml mm">  return () =&gt; (canceled = true);<br/>}, [person]);</span></pre><p id="4f19" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">å³ä½¿å‰ä¸€æ¬¡æŒ‰é’®ç‚¹å‡»çš„<code class="eh mb mc md me b">fakeFetch</code>æ‰¿è¯ºç¨åè§£å†³ï¼Œå®ƒçš„<code class="eh mb mc md me b">canceled</code>å˜é‡å°†è¢«è®¾ç½®ä¸º<code class="eh mb mc md me b">true</code>å¹¶ä¸”<code class="eh mb mc md me b">setData(data)</code>å°†ä¸ä¼šè¢«æ‰§è¡Œï¼</p><p id="6117" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">è®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬çš„æ–°åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•è¿è¡Œçš„:</p><figure class="kz la lb lc fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nc"><img src="../Images/fe5e368a11ef7d07f04771704dc2ddbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/0*rX3F44hi5ppWivEV.gif"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Clicking buttons quickly and avoiding the race condition</figcaption></figure><p id="c22f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">å®Œç¾â€”â€”æ— è®ºæˆ‘ä»¬ç‚¹å‡»ä¸åŒçš„æŒ‰é’®å¤šå°‘æ¬¡ï¼Œæˆ‘ä»¬å°†æ€»æ˜¯åªçœ‹åˆ°ä¸æœ€åä¸€æ¬¡æŒ‰é’®ç‚¹å‡»ç›¸å…³çš„æ•°æ®ã€‚</p><h1 id="d1e1" class="lf kf hu bd kg lg lh li kk lj lk ll ko lm ln lo kr lp lq lr ku ls lt lu kx lv dt translated">å®Œæ•´ä»£ç </h1><p id="94e3" class="pw-post-body-paragraph jg jh hu ji b jj lw jl jm jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd hn dt translated">è¿™ç¯‡åšæ–‡çš„å®Œæ•´ä»£ç å¯ä»¥åœ¨ä¸‹é¢æ‰¾åˆ°:</p><pre class="kz la lb lc fq mf me mg mh aw mi dt"><span id="a561" class="ke kf hu me b fv mj mk l ml mm">import React, { Fragment, useState, useEffect } from 'react';</span><span id="3afb" class="ke kf hu me b fv nb mk l ml mm">const fakeFetch = person =&gt; {<br/>  return new Promise(res =&gt; {<br/>    setTimeout(() =&gt; res(`${person}'s data`), Math.random() * 5000);<br/>  });<br/>};</span><span id="ea1e" class="ke kf hu me b fv nb mk l ml mm">const App = () =&gt; {<br/>  const [data, setData] = useState('');<br/>  const [loading, setLoading] = useState(false);<br/>  const [person, setPerson] = useState(null);</span><span id="e4d8" class="ke kf hu me b fv nb mk l ml mm">  useEffect(() =&gt; {<br/>    let canceled = false;</span><span id="ce80" class="ke kf hu me b fv nb mk l ml mm">    setLoading(true);<br/>    fakeFetch(person).then(data =&gt; {<br/>      if (!canceled) {<br/>        setData(data);<br/>        setLoading(false);<br/>      }<br/>    });</span><span id="377f" class="ke kf hu me b fv nb mk l ml mm">    return () =&gt; (canceled = true);<br/>  }, [person]);</span><span id="f9b6" class="ke kf hu me b fv nb mk l ml mm">  return (<br/>    &lt;Fragment&gt;<br/>      &lt;button onClick={() =&gt; setPerson('Nick')}&gt;Nick's Profile&lt;/button&gt;<br/>      &lt;button onClick={() =&gt; setPerson('Deb')}&gt;Deb's Profile&lt;/button&gt;<br/>      &lt;button onClick={() =&gt; setPerson('Joe')}&gt;Joe's Profile&lt;/button&gt;<br/>      {person &amp;&amp; (<br/>        &lt;Fragment&gt;<br/>          &lt;h1&gt;{person}&lt;/h1&gt;<br/>          &lt;p&gt;{loading ? 'Loading...' : data}&lt;/p&gt;<br/>        &lt;/Fragment&gt;<br/>      )}<br/>    &lt;/Fragment&gt;<br/>  );<br/>};<br/>export default App;</span></pre><figure class="kz la lb lc fq iv"><div class="bz el l di"><div class="nd le l"/></div></figure></div></div>    
</body>
</html>